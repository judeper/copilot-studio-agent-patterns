---
phase: 02-table-naming-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - enterprise-work-assistant/scripts/audit-table-naming.ps1
autonomous: true
requirements:
  - SCHM-07
must_haves:
  truths:
    - "A reusable PowerShell audit script exists that validates cr_assistantcard singular/plural naming conventions across the entire codebase"
    - "The audit script correctly classifies Dataverse API references by context -- singular for metadata operations, plural for OData data operations"
    - "The audit script excludes natural-language prose in comments, Write-Host strings, and documentation from violation detection"
    - "The audit script recognizes cr_assistantcardid as a correct primary key reference, not a table name violation"
    - "Running the audit script against the codebase produces zero violations"
    - "The audit script reports correct usages as positive confirmation alongside any violations"
  artifacts:
    - path: "enterprise-work-assistant/scripts/audit-table-naming.ps1"
      provides: "Reusable naming convention audit script"
      contains: "cr_assistantcard"
  key_links:
    - from: "enterprise-work-assistant/scripts/audit-table-naming.ps1"
      to: "all files in enterprise-work-assistant/"
      via: "Get-ChildItem -Recurse + Select-String pattern matching"
      pattern: "Get-ChildItem.*Recurse"
---

<objective>
Create a reusable PowerShell audit script that validates Dataverse table naming conventions (cr_assistantcard singular vs cr_assistantcards plural) across the entire codebase, then run it to confirm zero violations exist.

Purpose: SCHM-07 requires consistent singular/plural naming across all files. The audit script is both the verification mechanism and a permanent artifact that catches future regressions. Research confirmed the codebase currently has zero violations, so the script proves and maintains this correctness.

Output: `enterprise-work-assistant/scripts/audit-table-naming.ps1` -- a PowerShell script that reports violations and correct usages, with non-zero exit code on violations.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-table-naming-consistency/02-RESEARCH.md
@enterprise-work-assistant/scripts/provision-environment.ps1
@enterprise-work-assistant/scripts/create-security-roles.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PowerShell audit script for table naming conventions</name>
  <files>enterprise-work-assistant/scripts/audit-table-naming.ps1</files>
  <action>
Create `enterprise-work-assistant/scripts/audit-table-naming.ps1` following the existing script conventions from `provision-environment.ps1` and `create-security-roles.ps1`:

**Script structure (match existing conventions):**
- Comment-based help block: `.SYNOPSIS`, `.DESCRIPTION`, `.EXAMPLE`
- `param()` block with `[string]$SearchRoot = "."` parameter (path to scan, defaults to current directory)
- `$ErrorActionPreference = "Stop"`
- Section separators using `# ─────────────────────────────────────`
- `Write-Host` with `-ForegroundColor` for output (Green = correct, Red = violation, Yellow = info/excluded)

**Core logic:**

1. **File discovery:** Use `Get-ChildItem -Path $SearchRoot -Recurse -File` excluding paths matching `node_modules`, `out`, `bin`, `obj`, `.git` directories.

2. **Pattern search:** For each file, use `Get-Content` to read lines and search for any occurrence of `cr_assistantcard` (case-insensitive). This catches both singular and plural forms, plus the primary key `cr_assistantcardid`.

3. **Context-sensitive classification** -- for each match, classify as one of:
   - **CORRECT singular** -- line matches any of these metadata contexts:
     - `EntityDefinitions(LogicalName='..._assistantcard')` pattern
     - `SchemaName` assignment containing `_assistantcard`
     - Privilege name construction: `prv(Create|Read|Write|Delete|Append|AppendTo|Assign|Share)` followed by the entity name
     - `$entityName` variable assignment with singular value
     - Column logical name with table prefix: `cr_assistantcard\.cr_` (qualified column reference)
   - **CORRECT plural** -- line matches OData/entity set contexts:
     - OData URL path: `/cr_assistantcards` in URI strings
     - `@odata.bind` references with plural form
     - `entitySetName` property definition with plural value
   - **CORRECT primary key** -- line contains `cr_assistantcardid` (always correct, derived from logical name)
   - **CORRECT application-level** -- TypeScript `AssistantCard` type/interface references (no `cr_` prefix, not Dataverse-specific)
   - **EXCLUDED** -- natural language prose: comments (`//`, `#`, `/*`, `<!--`), `Write-Host` display strings, `.SYNOPSIS`/`.DESCRIPTION` docstrings, markdown prose. Report these separately as "excluded" not "correct" or "violation".
   - **VIOLATION** -- any `cr_assistantcard` reference that does not match the above correct/excluded patterns. Specifically:
     - Singular `cr_assistantcard` (without trailing `s` or `id`) in an OData URL context
     - Plural `cr_assistantcards` in a metadata/EntityDefinitions context
     - Any other ambiguous usage that doesn't fit known-correct patterns

4. **Reporting:**
   - Group results by file
   - For each match, print: `[STATUS] file:line -- context snippet`
   - Status colors: Green for CORRECT, Red for VIOLATION, DarkGray for EXCLUDED
   - Summary at end: total files scanned, total matches, correct count, violation count, excluded count
   - Also print: "PASS: No violations found" (green) or "FAIL: N violation(s) found" (red)

5. **Exit code:** Exit 0 if zero violations, exit 1 if any violations found.

**Important design notes:**
- The audit script itself will contain references to `cr_assistantcard` in its own pattern definitions. It should exclude itself from scanning, OR the references in the script's own regex patterns should be recognized as excluded (they are in string literals defining patterns, not functional Dataverse references). Simplest approach: add the script's own filename to an exclusion list.
- Match against the `cr_` prefixed forms only for Dataverse classification. The unprefixed `AssistantCard` in TypeScript is application-level and should be reported as "application-level" for completeness but is not a Dataverse naming concern.
- The publisher prefix is `cr` per project convention, but the script should work with the full `cr_assistantcard` pattern, not try to parameterize the prefix (the audit is specifically for this table's naming).
  </action>
  <verify>
Run `pwsh -File enterprise-work-assistant/scripts/audit-table-naming.ps1 -SearchRoot enterprise-work-assistant/` (or equivalent) and confirm the script:
1. Executes without errors
2. Scans all expected files (14+ files per research inventory)
3. Classifies matches into correct/excluded/violation categories
4. Prints a summary with counts
5. Reports zero violations and exits with code 0
  </verify>
  <done>
audit-table-naming.ps1 exists in enterprise-work-assistant/scripts/, runs without errors, correctly classifies all cr_assistantcard references by context, and reports zero violations with exit code 0. The script follows existing project PowerShell conventions (comment-based help, param block, section separators, colored output).
  </done>
</task>

<task type="auto">
  <name>Task 2: Run audit and fix any violations discovered</name>
  <files>enterprise-work-assistant/scripts/audit-table-naming.ps1</files>
  <action>
Run the audit script created in Task 1 against the full `enterprise-work-assistant/` directory:

```bash
cd enterprise-work-assistant && pwsh -File scripts/audit-table-naming.ps1 -SearchRoot .
```

**If zero violations (expected based on research):**
- Capture the output showing all classified matches and the "PASS" summary
- Verify the output includes positive confirmation of correct usages (not just absence of violations)
- Confirm the exit code is 0

**If violations are found (edge cases research may have missed):**
- For each violation, determine the correct form:
  - If in metadata context: must be singular `cr_assistantcard`
  - If in OData/data context: must be plural `cr_assistantcards`
- Fix each violation directly in the source file (in-place fix per user decision -- no review-per-fix needed)
- Re-run the audit script after fixes to confirm zero violations
- If the audit script itself has false positives (misclassifying correct usage as violation), fix the classification logic in the audit script rather than changing source files

**Final verification:**
- Run the audit script one final time
- Confirm the output shows: all expected files scanned, all matches correctly classified, zero violations, exit code 0
  </action>
  <verify>
Run the audit script and confirm:
1. Exit code is 0
2. Output shows "PASS: No violations found" (or equivalent)
3. Output includes positive confirmation of correct usages across all 14+ files
4. No files were incorrectly skipped or missed
  </verify>
  <done>
The audit script runs against the full codebase and confirms zero violations. All Dataverse table name references use the correct singular/plural form in their respective contexts. The audit output provides positive proof of naming consistency across all files.
  </done>
</task>

</tasks>

<verification>
1. `enterprise-work-assistant/scripts/audit-table-naming.ps1` exists and follows project PowerShell conventions
2. Running `pwsh -File enterprise-work-assistant/scripts/audit-table-naming.ps1 -SearchRoot enterprise-work-assistant/` produces zero violations
3. The audit script correctly distinguishes metadata contexts (singular) from OData contexts (plural) from application-level names from natural language prose
4. The audit output includes positive confirmation of correct usages, not just absence of violations
5. All 14+ files with cr_assistantcard references are scanned and classified
6. A grep for `cr_assistantcard` across the codebase (excluding node_modules/out/bin/obj) returns no results that the audit script missed
</verification>

<success_criteria>
- SCHM-07 satisfied: Table logical name uses consistent singular/plural convention across all files
- Reusable audit script exists as permanent verification artifact
- Zero violations confirmed by automated audit
- Audit script can be re-run after future changes to catch regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-table-naming-consistency/02-01-SUMMARY.md`
</output>
