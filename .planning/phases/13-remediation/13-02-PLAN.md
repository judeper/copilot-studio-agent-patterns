---
phase: 13-remediation
plan: 02
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - enterprise-work-assistant/docs/agent-flows.md
autonomous: true
requirements:
  - FIX-01
  - FIX-02

must_haves:
  truths:
    - "Card Outcome Tracker flow includes DISMISSED branch that increments cr_dismisscount"
    - "Daily Briefing flow spec defines all steps from trigger to card creation including output envelope wrapping"
    - "Command Execution flow spec defines Canvas trigger -> Orchestrator -> response return path"
    - "Staleness Monitor flow spec defines NUDGE creation via discrete column and EXPIRED transition at 7 days"
    - "Sender Profile Analyzer flow spec defines weekly categorization with dismiss_rate computation"
  artifacts:
    - path: "enterprise-work-assistant/docs/agent-flows.md"
      provides: "Complete flow specifications for all 9 flows"
      contains: "Flow 6"
  key_links:
    - from: "agent-flows.md Flow 5"
      to: "senderprofile-table.json cr_dismisscount"
      via: "DISMISSED branch increments dismiss count"
      pattern: "DISMISSED"
    - from: "agent-flows.md Flow 6"
      to: "output-schema.json"
      via: "Briefing response wrapped in standard envelope with draft_payload"
      pattern: "draft_payload"
    - from: "agent-flows.md Flow 7"
      to: "orchestrator-agent-prompt.md"
      via: "Command text passed to Orchestrator agent"
      pattern: "COMMAND_TEXT"
    - from: "agent-flows.md Flow 8"
      to: "useCardData.ts card_status"
      via: "Staleness Monitor sets discrete cr_cardstatus column to NUDGE"
      pattern: "NUDGE"
    - from: "agent-flows.md Flow 9"
      to: "senderprofile-table.json cr_sendercategory"
      via: "Weekly analyzer computes dismiss_rate and sets category"
      pattern: "dismiss_rate"
---

<objective>
Write the 4 missing flow specifications and fix the DISMISSED branch in the existing Card Outcome Tracker flow.

Purpose: These flow specs are the single biggest remediation driver -- they account for 4 Phase 10 BLOCK issues, enable 2 Phase 11 frontend fixes (F-01 depends on R-07, F-02 depends on R-06), and resolve 3 Phase 12 integration concerns (I-02/NUDGE, I-03/EXPIRED, I-15/BriefingCard). Writing these 5 flow changes unlocks resolution of 9 total BLOCK issues across all phases.

Output: Complete agent-flows.md with all 9 flow specifications fully documented.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-remediation/13-01-SUMMARY.md
@.planning/phases/12-integration-e2e-review/12-02-integration-review-verdict.md
@.planning/phases/10-platform-architecture-review/10-02-platform-review-verdict.md
@.planning/phases/12-integration-e2e-review/12-02-reconciled-findings.md

Source files:
@enterprise-work-assistant/docs/agent-flows.md
@enterprise-work-assistant/schemas/output-schema.json
@enterprise-work-assistant/prompts/orchestrator-agent-prompt.md
@enterprise-work-assistant/prompts/daily-briefing-agent-prompt.md
@enterprise-work-assistant/src/AssistantDashboard/components/BriefingCard.tsx
@enterprise-work-assistant/src/AssistantDashboard/hooks/useCardData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Card Outcome Tracker + write Daily Briefing and Staleness Monitor flow specs</name>
  <files>enterprise-work-assistant/docs/agent-flows.md</files>
  <action>
    **R-04 / I-05: Add DISMISSED and SENT_EDITED branches to Card Outcome Tracker (Flow 5)**
    - Find Flow 5 (Card Outcome Tracker) in agent-flows.md
    - Currently step 2 excludes DISMISSED ("no sender profile update needed") -- this is wrong
    - Add a DISMISSED branch that:
      1. Looks up sender email from the AssistantCard's cr_senderemail
      2. Looks up or creates SenderProfile row for that sender
      3. Increments cr_dismisscount by 1 (`cr_dismisscount + 1`)
      4. Continues to existing sender profile update logic (response count, etc.)
    - Add a SENT_EDITED branch that:
      1. Computes edit distance between cr_humanizeddraft and the final sent text (or simplifies to: if final differs from draft, mark as edited)
      2. Updates cr_avgeditdistance using running average formula: `((old_avg * old_count) + new_distance) / (old_count + 1)`
      3. Note: The exact Levenshtein computation is complex in Power Automate; document that a simplified "edited vs not edited" boolean comparison is acceptable for MVP
    - Ensure the flow step numbering is consistent with the existing format

    **R-07 / I-08 + I-02 + I-03: Write Staleness Monitor flow spec (Flow 8)**
    - Create a new Flow 8: Staleness Monitor section in agent-flows.md
    - Trigger: Scheduled (recurrence) -- runs every 4 hours (configurable)
    - Step-by-step specification:
      1. **Trigger:** Recurrence trigger, frequency = Hour, interval = 4
      2. **List PENDING cards:** Query Dataverse: `cr_assistantcards?$filter=cr_cardoutcome eq null and cr_cardstatus ne 100000004 and createdon lt @{addDays(utcNow(), -1)}` (cards older than 24 hours with no outcome and not already EXPIRED)
      3. **For each stale card:** Apply to each
      4. **Check age:** Condition: `dateDifference('Day', item()?['createdon'], utcNow()) >= 7`
         - **If >= 7 days (EXPIRED):**
           - Update cr_cardoutcome to EXPIRED (100000004)
           - Update cr_cardstatus to EXPIRED (100000004) via discrete column
         - **If < 7 days but > 24 hours (NUDGE):**
           - Update cr_cardstatus to NUDGE (100000004) via discrete column update (NOT through cr_fulljson)
           - Important: The discrete cr_cardstatus column is updated directly, not through the JSON blob. This is the key integration insight -- useCardData must read from the discrete column (fixed in Wave 3 F-01).
      5. **Error Scope:** Wrap steps 2-4 in a Scope with error handling that sends notification on failure
    - Document that NUDGE is set via discrete column, NOT in cr_fulljson, because the agent never produces NUDGE -- it is a system-managed status
    - Document that this flow resolves I-02 (NUDGE reachability), I-03 (EXPIRED writer), and enables F-01 (PCF card_status ingestion fix)

    **R-05 / I-06 + I-15: Write Daily Briefing flow spec (Flow 6)**
    - Create a new Flow 6: Daily Briefing section in agent-flows.md
    - Trigger: Scheduled (recurrence) -- runs daily at configured time (e.g., 7:00 AM user timezone)
    - Step-by-step specification:
      1. **Trigger:** Recurrence trigger, frequency = Day, interval = 1, startTime configured
      2. **Query open cards:** List AssistantCard records where cr_cardoutcome eq null and cr_cardstatus ne 100000004 (EXPIRED), sorted by cr_triagepriority desc, createdon desc. Limit to top 20.
      3. **Format card summaries:** Select action to extract key fields (cr_itemsummary, cr_triagetier, cr_triagepriority, cr_temporalhorizon, cr_cardstatus) into a JSON array for the briefing agent
      4. **Compose OPEN_CARDS:** Compose action to build the OPEN_CARDS string from the selected array
      5. **Invoke Daily Briefing Agent:** Use "Invoke a Copilot agent" action with input variable OPEN_CARDS = composed string
      6. **Parse briefing response:** Parse JSON of the agent response using briefing-output-schema.json structure (briefing_type, day_shape, action_items, fyi_items, stale_alerts)
      7. **CRITICAL -- Wrap in output envelope (I-15 fix):** Compose a standard output-schema.json envelope:
         ```json
         {
           "trigger_type": "DAILY_BRIEFING",
           "triage_tier": "FULL",
           "item_summary": "@{body('Parse_briefing_response')?['day_shape']}",
           "card_status": "READY",
           "priority": "N/A",
           "temporal_horizon": "N/A",
           "confidence_score": 100,
           "draft_payload": "@{string(body('Parse_briefing_response'))}",
           "triage_reasoning": "Daily briefing generated automatically",
           "verified_sources": []
         }
         ```
         Without this envelope wrapping, BriefingCard.tsx parseBriefing() would fail because it reads from card.draft_payload, and the raw briefing schema has no draft_payload field.
      8. **Create AssistantCard:** Create a new row in cr_assistantcards with:
         - cr_fulljson = string(envelope Compose output)
         - cr_triggertype = DAILY_BRIEFING (100000005)
         - cr_triagetier = FULL (100000000)
         - cr_cardstatus = READY (100000000)
         - cr_itemsummary = day_shape from briefing
         - cr_triagepriority = N/A (100000003)
         - cr_temporalhorizon = N/A (100000004)
         - cr_confidencescore = 100
      9. **Error Scope:** Wrap steps 2-8 in a Scope with error handling
    - Document that this flow MUST produce the output envelope format so BriefingCard can parse briefing data from draft_payload
  </action>
  <verify>
    <automated>grep -c "DISMISSED" enterprise-work-assistant/docs/agent-flows.md | grep -q '[2-9]' && echo "PASS: DISMISSED branch" || echo "FAIL"; grep -c "Staleness Monitor\|Flow 8" enterprise-work-assistant/docs/agent-flows.md | grep -q '[2-9]' && echo "PASS: Staleness Monitor" || echo "FAIL"; grep -c "Daily Briefing\|Flow 6" enterprise-work-assistant/docs/agent-flows.md | grep -q '[2-9]' && echo "PASS: Daily Briefing" || echo "FAIL"; grep -c "draft_payload" enterprise-work-assistant/docs/agent-flows.md | grep -q '[1-9]' && echo "PASS: envelope wrapping" || echo "FAIL"; grep -c "NUDGE" enterprise-work-assistant/docs/agent-flows.md | grep -q '[2-9]' && echo "PASS: NUDGE spec" || echo "FAIL"</automated>
  </verify>
  <done>
    - Flow 5 (Card Outcome Tracker) includes DISMISSED branch incrementing cr_dismisscount and SENT_EDITED branch computing edit distance
    - Flow 6 (Daily Briefing) fully specified with output envelope wrapping (I-15 fix)
    - Flow 8 (Staleness Monitor) fully specified with NUDGE via discrete column and EXPIRED at 7 days
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Command Execution and Sender Profile Analyzer flow specs</name>
  <files>enterprise-work-assistant/docs/agent-flows.md</files>
  <action>
    **R-06 / I-07 + R-18: Write Command Execution flow spec (Flow 7)**
    - Create a new Flow 7: Command Execution section in agent-flows.md
    - Trigger: When an AssistantCard is created with trigger_type = COMMAND (or when Canvas App fires a command via PCF output property)
    - Step-by-step specification:
      1. **Trigger:** Automated -- when Canvas App sets the PCF output property `commandText` (non-empty string)
         - Alternative trigger: HTTP request (called from Canvas App via Power Automate connector)
         - Document both options and recommend HTTP trigger for lower latency
      2. **Parse command:** Extract command text from trigger input
      3. **Invoke Orchestrator Agent:** Use "Invoke a Copilot agent" action with input variable COMMAND_TEXT = command text
         - The Orchestrator Agent has tool actions registered (CreateCard, UpdateCard, DismissCard, etc.) per R-18
         - Document that tool action registration must be completed in Copilot Studio admin: each tool (CreateCard, UpdateCard, DismissCard) maps to a Power Automate flow or Dataverse operation
      4. **Parse Orchestrator response:** Parse the agent's response (text summary of actions taken)
      5. **Return response to Canvas App:**
         - Option A (recommended): Update a shared Dataverse record that the PCF polls or watches
         - Option B: Use the flow's response action if triggered via HTTP
         - The response must include: success/failure status, summary text, list of actions taken
         - Document the response format so F-02 (Wave 3) can design the input property type:
           ```json
           {
             "status": "success|error",
             "summary": "Created reminder for tomorrow...",
             "actions_taken": ["CreateCard"],
             "error_message": null
           }
           ```
      6. **Error Scope:** Wrap steps 2-5 in error handling scope
    - Include R-18 documentation: List the Orchestrator's available tool actions and how they are registered in Copilot Studio (go to Agent -> Actions -> Add action -> select the corresponding Power Automate flow or Dataverse connector operation)

    **R-08 / I-09: Write Sender Profile Analyzer flow spec (Flow 9)**
    - Create a new Flow 9: Sender Profile Analyzer section in agent-flows.md
    - Trigger: Scheduled (recurrence) -- runs weekly (Sunday night or configurable)
    - Step-by-step specification:
      1. **Trigger:** Recurrence trigger, frequency = Week, interval = 1
      2. **List all SenderProfiles:** Query cr_senderprofiles (all rows, or filter to active senders with cr_responsecount > 0 or cr_dismisscount > 0)
      3. **For each SenderProfile:** Apply to each
      4. **Compute metrics:**
         - total_interactions = cr_responsecount + cr_dismisscount
         - dismiss_rate = cr_dismisscount / total_interactions (guard: if total_interactions = 0, dismiss_rate = 0)
         - response_rate = cr_responsecount / total_interactions
      5. **Categorize sender:** Condition tree based on Sprint 4 rules:
         - If cr_sendercategory already = USER_OVERRIDE (100000003) -> skip (user-managed, do not overwrite)
         - If dismiss_rate >= 0.6 AND total_interactions >= 5 -> set cr_sendercategory = AUTO_LOW (100000002)
         - If response_rate >= 0.8 AND total_interactions >= 5 -> set cr_sendercategory = AUTO_HIGH (100000001)
         - Else -> set cr_sendercategory = NEUTRAL (100000000)
         - The threshold of 5 minimum interactions prevents premature categorization
      6. **Update SenderProfile:** Patch cr_sendercategory with new value
      7. **Error Scope:** Wrap steps 2-6 in error handling scope
    - Document dependency: This flow depends on R-04 (DISMISSED branch) being implemented so cr_dismisscount actually increments. Without R-04, dismiss_rate is always 0 and AUTO_LOW never triggers.
    - Note: R-17 (SENDER_PROFILE not passed to agent) is a WARN-level deferral candidate. The analyzer flow still provides value by categorizing senders even if the agent does not yet consume the profile. Document this as a known gap for future fix.
  </action>
  <verify>
    <automated>grep -c "Command Execution\|Flow 7" enterprise-work-assistant/docs/agent-flows.md | grep -q '[2-9]' && echo "PASS: Command Execution" || echo "FAIL"; grep -c "Sender Profile Analyzer\|Flow 9" enterprise-work-assistant/docs/agent-flows.md | grep -q '[2-9]' && echo "PASS: Sender Profile Analyzer" || echo "FAIL"; grep -c "dismiss_rate" enterprise-work-assistant/docs/agent-flows.md | grep -q '[1-9]' && echo "PASS: dismiss_rate logic" || echo "FAIL"; grep -c "COMMAND_TEXT\|commandText" enterprise-work-assistant/docs/agent-flows.md | grep -q '[1-9]' && echo "PASS: command text" || echo "FAIL"</automated>
  </verify>
  <done>
    - Flow 7 (Command Execution) fully specified with Canvas trigger -> Orchestrator -> response return path
    - Flow 7 includes response format documentation for F-02 integration
    - Flow 7 includes R-18 Orchestrator tool action registration documentation
    - Flow 9 (Sender Profile Analyzer) fully specified with weekly categorization and dismiss_rate computation
    - Flow 9 documents dependency on R-04 for dismiss_count data
    - All flow specs follow the existing format in agent-flows.md (numbered steps, connector actions, expressions)
  </done>
</task>

</tasks>

<verification>
1. All 5 flow issues resolved: R-04 (DISMISSED branch), R-05 (Daily Briefing), R-06 (Command Execution), R-07 (Staleness Monitor), R-08 (Sender Profile Analyzer)
2. Integration requirements addressed: I-15 (envelope wrapping in Flow 6), I-02 (NUDGE via discrete column in Flow 8), I-03 (EXPIRED writer in Flow 8), I-05 (dismiss_count in Flow 5)
3. Cross-wave dependencies documented: Flow 8 NUDGE behavior enables F-01 fix, Flow 7 response format enables F-02 fix
4. R-18 (Orchestrator tool registration) documented within Flow 7 spec
5. agent-flows.md has 9 complete flow specifications (5 existing + 4 new)
</verification>

<success_criteria>
- agent-flows.md contains complete step-by-step specifications for Flow 6, 7, 8, and 9
- Flow 5 Card Outcome Tracker includes DISMISSED and SENT_EDITED branches
- Flow 6 Daily Briefing includes output envelope wrapping with draft_payload (I-15)
- Flow 7 Command Execution includes response format documentation (for F-02)
- Flow 8 Staleness Monitor documents NUDGE via discrete column (for F-01) and EXPIRED at 7 days (for I-03)
- Flow 9 Sender Profile Analyzer includes dismiss_rate categorization logic
- All flow specs follow existing formatting conventions in agent-flows.md
</success_criteria>

<output>
After completion, create `.planning/phases/13-remediation/13-02-SUMMARY.md`
</output>
