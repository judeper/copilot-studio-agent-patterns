---
phase: 13-remediation
plan: 04
type: execute
wave: 4
depends_on:
  - 13-03
files_modified:
  - .planning/phases/13-remediation/13-04-deferral-log.md
  - .planning/phases/13-remediation/13-04-final-validation.md
  - enterprise-work-assistant/scripts/provision-environment.ps1
  - enterprise-work-assistant/docs/deployment-guide.md
  - enterprise-work-assistant/src/AssistantDashboard/components/CardItem.tsx
autonomous: true
requirements:
  - FIX-03
  - FIX-04

must_haves:
  truths:
    - "Every non-blocking issue from Phases 10-12 has a documented deferral entry with severity, rationale, and suggested timeline"
    - "All 20 BLOCK issues from Phases 10-12 are verified as fixed in source files"
    - "Quick-fix deferral candidates are resolved where trivial"
    - "TypeScript type-check passes with no new errors"
    - "All existing tests pass with no regressions"
    - "No known deploy-blockers remain"
  artifacts:
    - path: ".planning/phases/13-remediation/13-04-deferral-log.md"
      provides: "Complete deferral log for all non-blocking issues"
      contains: "Deferral Log"
    - path: ".planning/phases/13-remediation/13-04-final-validation.md"
      provides: "Final validation report confirming all BLOCK issues resolved"
      contains: "PASS"
  key_links:
    - from: "13-04-final-validation.md"
      to: "12-02-integration-review-verdict.md"
      via: "Every BLOCK issue traced to fix commit"
      pattern: "RESOLVED"
---

<objective>
Create the deferral log for non-blocking issues, apply quick-fix deferral candidates, and run final validation to confirm all deploy-blocking issues are resolved.

Purpose: FIX-03 requires documenting all non-blocking issues with deferral rationale. FIX-04 requires verifying the final state is clean for deployment. This plan also applies trivial quick-fixes from the deferral candidate list to reduce future technical debt.

Output: Deferral log, final validation report, and several quick-fix improvements.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-remediation/13-01-SUMMARY.md
@.planning/phases/13-remediation/13-02-SUMMARY.md
@.planning/phases/13-remediation/13-03-SUMMARY.md
@.planning/phases/12-integration-e2e-review/12-02-integration-review-verdict.md
@.planning/phases/10-platform-architecture-review/10-02-platform-review-verdict.md
@.planning/phases/11-frontend-pcf-review/11-02-frontend-review-verdict.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deferral log and apply quick-fix deferral candidates</name>
  <files>
    .planning/phases/13-remediation/13-04-deferral-log.md
    enterprise-work-assistant/scripts/provision-environment.ps1
    enterprise-work-assistant/docs/deployment-guide.md
    enterprise-work-assistant/src/AssistantDashboard/components/CardItem.tsx
  </files>
  <action>
    **FIX-03: Create comprehensive deferral log**
    - Create `.planning/phases/13-remediation/13-04-deferral-log.md` with all WARN/INFO issues from all 3 review phases
    - Structure:

    ```markdown
    # Deferral Log -- v2.1 Pre-Deployment Audit

    ## Summary
    - Total deferred issues: {count}
    - Quick-fixed in Phase 13: {count}
    - Deferred to post-deployment: {count}

    ## Quick-Fixed in Phase 13

    | # | Issue ID | Phase | Fix Applied | Commit |
    |---|----------|-------|-------------|--------|

    ## Deferred to Post-Deployment

    | # | Issue ID | Phase | Issue | Severity | Deferral Rationale | Suggested Timeline |
    |---|----------|-------|-------|----------|-------------------|--------------------|
    ```

    - For each issue from the unified deferral candidates table in 12-02-integration-review-verdict.md (36 items), classify as either:
      a. **Quick-fixed:** Applied in this task (trivial, improves deployability)
      b. **Deferred:** With specific rationale and timeline

    **Quick-fix deferral candidates to apply now:**

    1. **R-11 (alternate key on SenderProfile):** Add alternate key creation for cr_senderemail in provision-environment.ps1:
       - After SenderProfile table creation, add: Create alternate key using Dataverse Web API POST to EntityKeyMetadata endpoint with KeyAttributes = ["cr_senderemail"]
       - This improves data integrity and prevents duplicate sender profiles

    2. **R-12 (Publish Customizations step):** Add `Publish-Customizations` call at end of provision-environment.ps1:
       - After all entity/column creation, add: `pac org publish --all` or Web API call to PublishAllXml
       - Required for customizations to take effect

    3. **R-13 (duplicate pac auth):** Remove duplicate `pac auth create` call in provision-environment.ps1:
       - Find the duplicate authentication block and remove it
       - Keep only the first occurrence

    4. **R-16 (SENDER_PROFILE in deployment guide):** Add SENDER_PROFILE to the input variable table in deployment-guide.md:
       - Find the table listing Copilot Studio input variables
       - Add row: `SENDER_PROFILE | JSON string | Serialized sender profile from SenderProfile table | Optional (Sprint 4) | null if no profile exists`

    5. **R-22 (Humanizer Connected Agent config):** Add one paragraph to deployment-guide.md:
       - In the Copilot Studio configuration section, add: "Humanizer Agent: Create a Connected Agent reference in the main agent's configuration. Go to Agent -> Actions -> Add action -> select 'Invoke a Copilot agent' -> select the Humanizer Agent. Map the input variable draft_text to the agent's draft payload."

    6. **R-37 (Agent publish verification):** Add verification step to deployment-guide.md:
       - After agent publish instructions, add: "Verify publication by testing each agent in the Copilot Studio Test pane. Send a sample email signal payload and confirm the agent returns a valid JSON response matching output-schema.json."

    7. **F-15 (NUDGE in CardItem status map):** In CardItem.tsx, add NUDGE to the status display map:
       - Find the status color/icon map (where READY, PROCESSING, etc. are mapped to visual indicators)
       - Add NUDGE entry: `"NUDGE": { color: "warning" / orange, icon: "clock" / alert, label: "Needs Attention" }`

    8. **F-16 (trigger icon map):** In CardItem.tsx, complete the trigger type icon map:
       - Add missing trigger types: DAILY_BRIEFING, COMMAND, SELF_REMINDER
       - Map to appropriate Fluent UI icons or emoji indicators

    9. **F-22 (React ESLint plugins):** Note in deferral log as "quick-fix candidate for next session" -- requires npm install which is beyond doc remediation scope

    10. **I-33 (environment config docs):** Add environment configuration section to deployment-guide.md:
        - List all connection references needed for solution packaging
        - List all environment variables (AdminNotificationEmail from I-18, etc.)
        - Add Canvas App formula reference for PCF-to-flow wiring

    **Deferred issues (document with rationale):**

    For each remaining WARN/INFO issue not quick-fixed:
    - R-14 (PAC CLI version): Defer -- operational documentation, not an artifact fix
    - R-15/I-19 (Trigger Type Compose scope): Defer -- add comment to flows, functional as-is
    - R-19/I-22 (Sender profile upsert race): Defer -- requires R-11 alternate key (being quick-fixed) but needs flow-level Upsert change
    - R-20 (NuGet restore): Defer -- build toolchain concern
    - R-21 (Unmanaged solution): Defer -- production packaging concern
    - R-23 (Knowledge source configs): Defer -- environment-specific
    - R-30-R-33 (Agent timeout, rate limits, capacity, license docs): Defer -- operational documentation
    - R-34 (maxLength truncation): Defer -- defensive measure, low risk
    - R-35 (Briefing schedule table): Defer -- tech debt #13 already reclassified
    - F-09-F-12 (Plain HTML): Defer -- visual consistency, no correctness impact
    - F-13 (Loading state): Defer -- UX improvement
    - F-14 (BriefingCard Back button): Defer -- UX improvement
    - F-17 (ARIA labels): Defer -- accessibility, post-deployment
    - F-18 (Escape key): Defer -- keyboard navigation, post-deployment
    - F-19 (Misleading 0%): Defer -- UX edge case
    - F-20/I-32 (DataSet paging): Defer -- mitigated by staleness expiration
    - F-21 (Calibration view tests): Defer -- additional test coverage
    - I-21 (SENT_EDITED): Defer -- analytics accuracy, non-blocking
    - I-23 (Concurrent outcome race): Defer -- low probability, minor drift
    - I-28 (Draft edits not persisted): Defer -- UX improvement
    - I-29 (Dismiss error handling): Defer -- low-frequency failure
    - I-30 (Dead-letter mechanism): Defer -- operational concern
    - I-31 (Reminder firing): Defer -- incomplete feature
  </action>
  <verify>
    <automated>test -f .planning/phases/13-remediation/13-04-deferral-log.md && echo "PASS: deferral log exists" || echo "FAIL"; grep -c "Deferred" .planning/phases/13-remediation/13-04-deferral-log.md | grep -q '[1-9]' && echo "PASS: deferrals documented" || echo "FAIL"; grep -c "NUDGE" enterprise-work-assistant/src/AssistantDashboard/components/CardItem.tsx | grep -q '[1-9]' && echo "PASS: NUDGE in CardItem" || echo "FAIL"; grep -c "SENDER_PROFILE" enterprise-work-assistant/docs/deployment-guide.md | grep -q '[1-9]' && echo "PASS: SENDER_PROFILE in guide" || echo "FAIL"; grep -c "PublishAll\|publish" enterprise-work-assistant/scripts/provision-environment.ps1 | grep -q '[1-9]' && echo "PASS: publish step" || echo "FAIL"</automated>
  </verify>
  <done>
    - Deferral log created with all WARN/INFO issues from Phases 10-12
    - Each deferred issue has: severity, description, deferral rationale, suggested timeline
    - Quick-fix candidates applied: R-11 (alternate key), R-12 (publish step), R-13 (duplicate auth), R-16 (SENDER_PROFILE docs), R-22 (Humanizer docs), R-37 (publish verification), F-15 (NUDGE map), F-16 (trigger icons), I-33 (environment config)
    - All deferred issues have documented rationale
  </done>
</task>

<task type="auto">
  <name>Task 2: Run final validation and produce validation report</name>
  <files>
    .planning/phases/13-remediation/13-04-final-validation.md
  </files>
  <action>
    **FIX-04: Final validation pass**

    Run comprehensive validation and produce a report. Execute these checks:

    1. **TypeScript type-check:**
       - Run `cd enterprise-work-assistant/src && npx tsc --noEmit` (or the project's configured type-check command)
       - Record pass/fail and any errors

    2. **Test suite:**
       - Run `cd enterprise-work-assistant/src && npx jest --config test/jest.config.ts --verbose`
       - Record pass/fail, test count, and any failures
       - Specifically verify new tests (ConfidenceCalibration.test.tsx, index.test.ts) pass

    3. **BLOCK issue trace:**
       - For each of the 20 BLOCK issues from 12-02-integration-review-verdict.md, verify the fix exists in the source file:
         - R-01: "N/A" in output-schema.json enum
         - R-02: "USER_OVERRIDE" in main-agent-system-prompt.md (no "USER_VIP")
         - R-03: PascalCase in create-security-roles.ps1
         - R-04: DISMISSED branch in agent-flows.md Flow 5
         - R-05: Flow 6 (Daily Briefing) complete in agent-flows.md
         - R-06: Flow 7 (Command Execution) complete in agent-flows.md
         - R-07: Flow 8 (Staleness Monitor) complete in agent-flows.md
         - R-08: Flow 9 (Sender Profile Analyzer) complete in agent-flows.md
         - R-09: Publisher validation in provision-environment.ps1
         - F-01: getFormattedValue in useCardData.ts
         - F-02: orchestratorResponse in ControlManifest.Input.xml
         - F-03: ErrorBoundary.tsx exists and is used in App.tsx
         - F-04: ConfidenceCalibration.test.tsx exists
         - F-05: index.test.ts exists
         - F-06: dataset in useMemo dependency array
         - F-07: Tech debt #13 reclassified
         - F-08: Tech debt #7 reclassified
         - I-16: Injection defense in all 3 prompts
         - I-17: Staleness refresh documented
         - I-18: Monitoring strategy defined
       - For each: grep the target string in the file and record RESOLVED or UNRESOLVED

    4. **Regression check:**
       - Verify no existing source files were accidentally deleted or corrupted
       - Verify output-schema.json is valid JSON: `node -e "JSON.parse(require('fs').readFileSync('enterprise-work-assistant/schemas/output-schema.json', 'utf8'))"`
       - Verify ControlManifest.Input.xml is valid XML structure

    5. **Produce validation report:**
       Create `.planning/phases/13-remediation/13-04-final-validation.md`:

       ```markdown
       # Final Validation Report -- Phase 13 Remediation

       ## Summary
       - TypeScript type-check: PASS/FAIL
       - Test suite: PASS/FAIL ({N} tests, {N} passed, {N} failed)
       - BLOCK issues resolved: {N}/20
       - Regressions found: {N}
       - Overall verdict: PASS/FAIL

       ## BLOCK Issue Resolution Trace

       | # | Issue ID | Fix Location | Verification | Status |
       |---|----------|-------------|--------------|--------|
       | 1 | R-01 | output-schema.json | "N/A" in priority enum | RESOLVED |
       | ... | ... | ... | ... | ... |

       ## Test Results
       [detailed test output]

       ## Deployment Readiness
       - [ ] All BLOCK issues resolved
       - [ ] All tests pass
       - [ ] Type-check clean
       - [ ] Deferral log complete
       - [ ] No known deploy-blockers remain
       ```

    6. **If any check FAILS:** Document the failure in the report with specific details. Do NOT mark FIX-04 as complete if any BLOCK issue is unresolved.
  </action>
  <verify>
    <automated>test -f .planning/phases/13-remediation/13-04-final-validation.md && echo "PASS: validation report exists" || echo "FAIL"; grep -c "RESOLVED" .planning/phases/13-remediation/13-04-final-validation.md | grep -q '[1-9]' && echo "PASS: issues traced" || echo "FAIL"</automated>
  </verify>
  <done>
    - Final validation report exists at .planning/phases/13-remediation/13-04-final-validation.md
    - All 20 BLOCK issues are traced to their fix locations with RESOLVED status
    - TypeScript type-check result documented
    - Test suite results documented (including new tests)
    - Overall deployment readiness verdict is PASS (or FAIL with specific items listed)
    - No known deploy-blockers remain
  </done>
</task>

</tasks>

<verification>
1. FIX-03 complete: Deferral log covers all WARN/INFO issues from all 3 review phases
2. FIX-04 complete: Final validation confirms all 20 BLOCK issues resolved, tests pass, types check
3. Quick-fixes applied: 9+ trivial improvements from deferral candidate list
4. No regressions: All existing tests pass, no corrupted files
5. Deployment readiness: Explicit checklist in validation report
</verification>

<success_criteria>
- Deferral log (.planning/phases/13-remediation/13-04-deferral-log.md) documents all non-blocking issues
- Each deferred issue has severity, rationale, and suggested timeline
- Quick-fix deferral candidates applied (R-11, R-12, R-13, R-16, R-22, R-37, F-15, F-16, I-33)
- Final validation report (.planning/phases/13-remediation/13-04-final-validation.md) shows all 20 BLOCK issues RESOLVED
- TypeScript type-check passes
- All tests pass (including new ConfidenceCalibration and index tests)
- Overall deployment readiness verdict is PASS
</success_criteria>

<output>
After completion, create `.planning/phases/13-remediation/13-04-SUMMARY.md`
</output>
