---
phase: 08-test-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - enterprise-work-assistant/src/AssistantDashboard/hooks/__tests__/useCardData.test.ts
  - enterprise-work-assistant/src/AssistantDashboard/utils/__tests__/urlSanitizer.test.ts
  - enterprise-work-assistant/src/AssistantDashboard/components/__tests__/App.test.tsx
  - enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardItem.test.tsx
  - enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardDetail.test.tsx
  - enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardGallery.test.tsx
  - enterprise-work-assistant/src/AssistantDashboard/components/__tests__/FilterBar.test.tsx
autonomous: true
requirements:
  - TEST-02
  - TEST-03
  - TEST-04

must_haves:
  truths:
    - "useCardData hook correctly parses valid JSON records into AssistantCard arrays"
    - "useCardData hook returns empty array for undefined dataset, empty dataset, and skips malformed JSON records"
    - "useCardData hook handles tier-specific field presence (SKIP has null fields, FULL has all fields)"
    - "App filter logic correctly filters cards by trigger type, priority, card status, and temporal horizon independently and in combination"
    - "CardItem renders card summary, status badge, and calls onClick handler"
    - "CardDetail renders all card sections (summary, badges, key findings, sources, draft) for a full-tier card"
    - "CardGallery renders cards and shows empty state message when no cards match"
    - "FilterBar shows card count and active filter badges"
    - "urlSanitizer accepts https/mailto and rejects javascript:/data:/null/empty"
    - "npx jest passes with all tests green and meets 80% per-file coverage threshold"
  artifacts:
    - path: "enterprise-work-assistant/src/AssistantDashboard/hooks/__tests__/useCardData.test.ts"
      provides: "Hook tests for JSON parsing, edge cases, tier behavior"
      min_lines: 60
    - path: "enterprise-work-assistant/src/AssistantDashboard/utils/__tests__/urlSanitizer.test.ts"
      provides: "Utility tests for URL protocol validation"
      min_lines: 30
    - path: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/App.test.tsx"
      provides: "Filter logic tests via rendered App component"
      min_lines: 60
    - path: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardItem.test.tsx"
      provides: "CardItem render and click handler tests"
      min_lines: 25
    - path: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardDetail.test.tsx"
      provides: "CardDetail section rendering tests"
      min_lines: 40
    - path: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardGallery.test.tsx"
      provides: "CardGallery rendering and empty state tests"
      min_lines: 20
    - path: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/FilterBar.test.tsx"
      provides: "FilterBar count and badge display tests"
      min_lines: 20
  key_links:
    - from: "enterprise-work-assistant/src/AssistantDashboard/hooks/__tests__/useCardData.test.ts"
      to: "enterprise-work-assistant/src/test/mocks/componentFramework.ts"
      via: "imports createMockDataset"
      pattern: "createMockDataset"
    - from: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/App.test.tsx"
      to: "enterprise-work-assistant/src/test/helpers/renderWithProviders.tsx"
      via: "imports renderWithProviders"
      pattern: "renderWithProviders"
    - from: "enterprise-work-assistant/src/AssistantDashboard/components/__tests__/App.test.tsx"
      to: "enterprise-work-assistant/src/test/fixtures/cardFixtures.ts"
      via: "imports tier fixture data"
      pattern: "tier.*Item"
---

<objective>
Write unit tests for all testable source files: useCardData hook, urlSanitizer utility, and all four components (CardItem, CardDetail, CardGallery, FilterBar) plus App filter logic. Tests use the infrastructure from Plan 01.

Purpose: Demonstrate testing practices for the reference pattern. Tests verify core logic (data parsing, filtering, URL sanitization) and component rendering with realistic mock data.
Output: All tests pass. Coverage meets 80% per-file threshold.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-test-infrastructure/08-RESEARCH.md
@.planning/phases/08-test-infrastructure/08-01-SUMMARY.md
@enterprise-work-assistant/src/AssistantDashboard/hooks/useCardData.ts
@enterprise-work-assistant/src/AssistantDashboard/utils/urlSanitizer.ts
@enterprise-work-assistant/src/AssistantDashboard/components/App.tsx
@enterprise-work-assistant/src/AssistantDashboard/components/CardItem.tsx
@enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx
@enterprise-work-assistant/src/AssistantDashboard/components/CardGallery.tsx
@enterprise-work-assistant/src/AssistantDashboard/components/FilterBar.tsx
@enterprise-work-assistant/src/AssistantDashboard/components/types.ts
@enterprise-work-assistant/src/AssistantDashboard/components/constants.ts
@enterprise-work-assistant/src/test/mocks/componentFramework.ts
@enterprise-work-assistant/src/test/helpers/renderWithProviders.tsx
@enterprise-work-assistant/src/test/fixtures/cardFixtures.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write useCardData hook tests and urlSanitizer utility tests</name>
  <files>
    enterprise-work-assistant/src/AssistantDashboard/hooks/__tests__/useCardData.test.ts
    enterprise-work-assistant/src/AssistantDashboard/utils/__tests__/urlSanitizer.test.ts
  </files>
  <action>
    **useCardData tests (`hooks/__tests__/useCardData.test.ts`):**

    Import `renderHook` from `@testing-library/react`, `useCardData` from the hook, and `createMockDataset` from `test/mocks/componentFramework`. Import relevant fixtures from `test/fixtures/cardFixtures`.

    Test cases (TEST-02 requirements):
    1. **Valid JSON parsing:** Create a mock dataset with one record containing valid cr_fulljson (full-tier item with all fields). Call `renderHook(() => useCardData(dataset, 1))`. Assert `result.current` has length 1, assert trigger_type, triage_tier, item_summary, priority, confidence_score match the JSON input.
    2. **Multiple records:** Create dataset with 3 records (one per tier). Assert all 3 are returned with correct types.
    3. **Undefined dataset:** Call with `undefined`. Assert returns empty array.
    4. **Empty dataset:** Call with `{ sortedRecordIds: [], records: {} }`. Assert returns empty array.
    5. **Malformed JSON handling:** Create dataset with one malformed record (invalid JSON string) and one valid record. Assert returns array with only the valid record (malformed is skipped, not thrown).
    6. **Null cr_fulljson:** Create record where `getValue("cr_fulljson")` returns null. Assert record is skipped.
    7. **Tier-specific field presence — SKIP:** Create record with SKIP tier JSON (priority null, confidence_score absent). Assert priority is null, confidence_score is null.
    8. **Tier-specific field presence — FULL:** Create record with FULL tier JSON (all fields present including verified_sources array). Assert verified_sources is an array, confidence_score is a number.
    9. **N/A ingestion boundary:** Create record where priority is "N/A" in JSON. Assert the parsed card has `priority: null` (the useCardData hook converts "N/A" to null).
    10. **humanized_draft from separate column:** Create record with cr_humanizeddraft column value. Assert humanized_draft is populated from `getValue("cr_humanizeddraft")`, not from cr_fulljson.
    11. **created_on from getFormattedValue:** Assert created_on comes from `getFormattedValue("createdon")`.

    **urlSanitizer tests (`utils/__tests__/urlSanitizer.test.ts`):**

    Import `isSafeUrl` and `SAFE_PROTOCOLS` from the utility.

    Test cases:
    1. Accepts `https://example.com` → true
    2. Accepts `mailto:user@example.com` → true
    3. Rejects `javascript:alert(1)` → false
    4. Rejects `data:text/html,<script>` → false
    5. Rejects `vbscript:msgbox` → false
    6. Returns false for null → false
    7. Returns false for undefined → false
    8. Returns false for empty string → false
    9. Handles case-insensitive: `HTTPS://EXAMPLE.COM` → true
    10. Rejects `http://example.com` → false (only https allowed per Phase 5 decision)
    11. Rejects relative URLs (no scheme): `example.com/path` → false
    12. SAFE_PROTOCOLS contains exactly `https:` and `mailto:`

    **Important:** Do NOT mock Fluent UI components — user explicitly decided to render real components. These are pure logic tests — no FluentProvider needed for hook or utility tests.
  </action>
  <verify>
    ```bash
    cd enterprise-work-assistant/src && npx jest --testPathPattern="useCardData|urlSanitizer" --verbose
    ```
    All tests pass. No type errors during compilation.
  </verify>
  <done>useCardData hook tests cover JSON parsing, malformed data, empty/undefined datasets, tier-specific fields, N/A ingestion boundary, and column-specific extraction. urlSanitizer tests cover all protocol cases including edge cases. All tests green.</done>
</task>

<task type="auto">
  <name>Task 2: Write component render tests for App, CardItem, CardDetail, CardGallery, and FilterBar</name>
  <files>
    enterprise-work-assistant/src/AssistantDashboard/components/__tests__/App.test.tsx
    enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardItem.test.tsx
    enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardDetail.test.tsx
    enterprise-work-assistant/src/AssistantDashboard/components/__tests__/CardGallery.test.tsx
    enterprise-work-assistant/src/AssistantDashboard/components/__tests__/FilterBar.test.tsx
  </files>
  <action>
    All component tests import `renderWithProviders` from `test/helpers/renderWithProviders` and fixture data from `test/fixtures/cardFixtures`. Import `screen` from `@testing-library/react` and `userEvent` from `@testing-library/user-event` where click testing is needed.

    **App.test.tsx (TEST-03 — Filter logic):**

    App.tsx has a private `applyFilters` function. Per Research Pitfall #4, test through rendered output, not by importing it.

    Test cases:
    1. **No filters:** Render App with `[tier2LightItem, tier3FullItem]`, all filter props empty string. Assert both item summaries appear in the document.
    2. **Filter by trigger type:** Set `filterTriggerType="EMAIL"`. Assert tier3FullItem (EMAIL) visible, tier2LightItem (TEAMS_MESSAGE) not visible.
    3. **Filter by priority:** Set `filterPriority="High"`. Assert tier3FullItem (High) visible, tier2LightItem (Medium) not visible.
    4. **Filter by card status:** Set `filterCardStatus="READY"`. Assert tier3FullItem (READY) visible, tier2LightItem (SUMMARY_ONLY) not visible.
    5. **Filter by temporal horizon:** Set `filterTemporalHorizon="TODAY"`. Assert tier3FullItem (TODAY) visible, tier2LightItem (THIS_WEEK) not visible.
    6. **Combined filters:** Set multiple filters that match tier3FullItem only. Assert only tier3FullItem appears.
    7. **No matches:** Set filters that match nothing. Assert "No cards match" empty state text appears (from CardGallery).
    8. **All cards pass:** All filters empty, all cards shown.

    Notes for App rendering: App accepts `onSelectCard`, `onEditDraft`, `onDismissCard` — use `jest.fn()` for all. App already wraps in FluentProvider internally, but `renderWithProviders` adds another — this is fine per Fluent UI nesting behavior. Alternatively, render App directly with `render()` from RTL since App has its own FluentProvider.

    **CardItem.test.tsx (TEST-04):**
    1. **Renders summary text:** Render with tier3FullItem. Assert `item_summary` text present.
    2. **Renders status badge:** Assert card_status "READY" text present.
    3. **Renders temporal horizon badge:** Assert "TODAY" badge present for tier3FullItem.
    4. **Hides temporal horizon when null:** Render with tier1SkipItem (temporal_horizon null). Assert "TODAY"/"THIS_WEEK" text NOT present.
    5. **Renders created_on footer:** Assert created_on text present.
    6. **Click handler:** Click on the card, assert `onClick` was called with `card.id`.

    **CardDetail.test.tsx (TEST-04):**
    1. **Renders summary:** Render with tier3FullItem. Assert item_summary as heading text.
    2. **Renders priority badge:** Assert "High" text present.
    3. **Renders confidence badge:** Assert "Confidence: 87%" text present.
    4. **Renders trigger type badge:** Assert "EMAIL" text present.
    5. **Renders key findings section:** Assert "Key Findings" heading present, assert findings text visible.
    6. **Renders research log:** Assert "Research Log" heading present.
    7. **Renders verified sources with safe URLs as links:** Render with tier3FullItem (has https source). Assert source title is a link element.
    8. **Renders unsafe URLs as plain text:** Create a card fixture with a `javascript:` source URL. Assert source title is text, NOT a link.
    9. **Renders humanized draft textarea:** Assert textarea with humanized draft content.
    10. **Renders low confidence warning:** Render with lowConfidenceItem. Assert warning message bar present with the low_confidence_note text.
    11. **Back button calls onBack:** Click "Back" button, assert `onBack` called.
    12. **Edit & Copy Draft button calls onEditDraft:** Click button, assert `onEditDraft` called with card.id.
    13. **Dismiss button calls onDismissCard:** Click "Dismiss Card", assert `onDismissCard` called with card.id.

    **CardGallery.test.tsx (TEST-04):**
    1. **Renders cards:** Render with `[tier2LightItem, tier3FullItem]`. Assert both summaries visible.
    2. **Empty state:** Render with empty array. Assert "No cards match the current filters." text present.
    3. **Click propagation:** Click a card, assert `onSelectCard` called with correct id.

    **FilterBar.test.tsx (TEST-04):**
    1. **Shows card count singular:** Render with `cardCount={1}`. Assert "1 card" text.
    2. **Shows card count plural:** Render with `cardCount={5}`. Assert "5 cards" text.
    3. **Shows active filter badges:** Render with `filterPriority="High"`. Assert "High" badge visible.
    4. **Shows multiple filter badges:** Set multiple filters. Assert all filter values appear.
    5. **Hides filter badges when no filters:** All filter props empty. Assert no badge elements beyond the count text.

    **Critical reminders:**
    - Do NOT mock Fluent UI components — render them real (user locked decision)
    - Do NOT attempt to import `applyFilters` from App.tsx — it is not exported
    - Do NOT assert on computed CSS values (Pitfall #5) — assert on text content, element presence, ARIA attributes
    - Use `userEvent` for click interactions (more realistic than `fireEvent`)
    - Each test file must meet 80% per-file coverage for the file(s) it exercises
  </action>
  <verify>
    ```bash
    cd enterprise-work-assistant/src && npx jest --verbose --coverage
    ```
    All tests pass. Coverage report shows >= 80% per-file for branches, functions, lines, statements on all tested source files. No warnings or type errors.
  </verify>
  <done>All 7 test files pass. Filter logic verified through 5+ scenarios covering each filter dimension independently and combined. Each component (CardItem, CardDetail, CardGallery, FilterBar) has at least one render test with valid mock data. Coverage meets 80% per-file threshold. All tests use real Fluent UI component rendering.</done>
</task>

</tasks>

<verification>
1. `cd enterprise-work-assistant/src && npx jest --verbose` — all tests pass
2. `npx jest --coverage` — every tested file meets 80% per-file threshold
3. Hook tests cover: valid parsing, malformed JSON, empty dataset, undefined dataset, tier-specific fields
4. Filter tests cover: each filter dimension independently and combined
5. Component tests: each of CardItem, CardDetail, CardGallery, FilterBar has at least one passing render test
6. urlSanitizer tests cover: https, mailto, javascript, data, null, undefined, empty, case-insensitive
7. No Fluent UI components are mocked — all render real components
</verification>

<success_criteria>
- `npx jest` exits 0 with all tests passing
- Coverage meets 80% per-file threshold for all tested source files
- useCardData hook tests exercise JSON parsing, error handling, and tier-specific behavior
- App filter logic tested through rendered component output (not by importing private function)
- Each of the 4 required components has at least one render test with valid data
- urlSanitizer tests cover safe/unsafe/edge-case protocols
- Tests demonstrate reference pattern best practices (real Fluent rendering, accessible queries, factory fixtures)
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-infrastructure/08-02-SUMMARY.md`
</output>
