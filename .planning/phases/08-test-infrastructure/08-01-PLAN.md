---
phase: 08-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - enterprise-work-assistant/src/package.json
  - enterprise-work-assistant/src/test/jest.config.ts
  - enterprise-work-assistant/src/test/jest.setup.ts
  - enterprise-work-assistant/src/tsconfig.test.json
  - enterprise-work-assistant/src/test/mocks/componentFramework.ts
  - enterprise-work-assistant/src/test/helpers/renderWithProviders.tsx
  - enterprise-work-assistant/src/test/fixtures/cardFixtures.ts
autonomous: true
requirements:
  - TEST-01

must_haves:
  truths:
    - "npx jest --passWithNoTests runs without configuration errors from the enterprise-work-assistant/src/ directory"
    - "TypeScript test files compile successfully via ts-jest with the test tsconfig"
    - "FluentProvider wrapper is available as a renderWithProviders helper for component tests"
    - "Realistic fixture data exists for all three triage tiers (SKIP, LIGHT, FULL) plus edge cases"
    - "ComponentFramework mock satisfies the DataSet/DataSetRecord interfaces used by useCardData"
  artifacts:
    - path: "enterprise-work-assistant/src/test/jest.config.ts"
      provides: "Jest configuration with ts-jest, jsdom, coverage thresholds"
      contains: "testEnvironment"
    - path: "enterprise-work-assistant/src/test/jest.setup.ts"
      provides: "jest-dom matchers and matchMedia polyfill"
      contains: "matchMedia"
    - path: "enterprise-work-assistant/src/tsconfig.test.json"
      provides: "Test-specific TypeScript config extending main tsconfig"
      contains: "CommonJS"
    - path: "enterprise-work-assistant/src/test/mocks/componentFramework.ts"
      provides: "Factory function for creating mock PCF datasets"
      exports: ["createMockDataset"]
    - path: "enterprise-work-assistant/src/test/helpers/renderWithProviders.tsx"
      provides: "FluentProvider wrapper for component tests"
      exports: ["renderWithProviders"]
    - path: "enterprise-work-assistant/src/test/fixtures/cardFixtures.ts"
      provides: "Shared test fixtures mirroring Copilot Studio JSON output"
      exports: ["tier1SkipItem", "tier2LightItem", "tier3FullItem"]
  key_links:
    - from: "enterprise-work-assistant/src/test/jest.config.ts"
      to: "enterprise-work-assistant/src/tsconfig.test.json"
      via: "ts-jest tsconfig option"
      pattern: "tsconfig.*test"
    - from: "enterprise-work-assistant/src/test/jest.config.ts"
      to: "enterprise-work-assistant/src/test/jest.setup.ts"
      via: "setupFilesAfterEnv"
      pattern: "setupFilesAfterEnv"
    - from: "enterprise-work-assistant/src/test/fixtures/cardFixtures.ts"
      to: "enterprise-work-assistant/src/AssistantDashboard/components/types.ts"
      via: "imports AssistantCard type"
      pattern: "import.*AssistantCard"
---

<objective>
Configure Jest, ts-jest, and React Testing Library for the PCF project with all shared test infrastructure: configuration files, ComponentFramework mocks, FluentProvider helper, and realistic fixture data.

Purpose: Establish the test foundation so that Plan 02 can write tests without any setup work. This is the reference pattern's test infrastructure — documented and reusable.
Output: Working Jest configuration, test helpers, mocks, and fixtures. `npx jest --passWithNoTests` succeeds.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-test-infrastructure/08-RESEARCH.md
@enterprise-work-assistant/src/package.json
@enterprise-work-assistant/src/tsconfig.json
@enterprise-work-assistant/src/AssistantDashboard/components/types.ts
@enterprise-work-assistant/src/AssistantDashboard/hooks/useCardData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and create Jest configuration</name>
  <files>
    enterprise-work-assistant/src/package.json
    enterprise-work-assistant/src/test/jest.config.ts
    enterprise-work-assistant/src/test/jest.setup.ts
    enterprise-work-assistant/src/tsconfig.test.json
  </files>
  <action>
    **Step 1 — Install dependencies.** From `enterprise-work-assistant/src/`, run:
    ```bash
    bun add -d jest ts-jest @types/jest jest-environment-jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event identity-obj-proxy
    ```
    Also add a `test` script to package.json:
    ```json
    "test": "jest --config test/jest.config.ts"
    ```

    **Step 2 — Create `tsconfig.test.json`** in `enterprise-work-assistant/src/`. This extends the main tsconfig but overrides `module` to CommonJS for Jest compatibility and adds test-specific types:
    ```json
    {
      "extends": "./tsconfig.json",
      "compilerOptions": {
        "module": "CommonJS",
        "types": ["jest", "@testing-library/jest-dom"],
        "jsx": "react",
        "esModuleInterop": true
      },
      "include": [
        "AssistantDashboard/**/*.ts",
        "AssistantDashboard/**/*.tsx",
        "test/**/*.ts",
        "test/**/*.tsx"
      ]
    }
    ```

    **Step 3 — Create `test/jest.config.ts`:**
    - `rootDir: '..'` (points to `enterprise-work-assistant/src/`)
    - `testEnvironment: 'jest-environment-jsdom'`
    - `preset: 'ts-jest'` with tsconfig override pointing to `tsconfig.test.json`
    - `testMatch: ['<rootDir>/AssistantDashboard/**/__tests__/**/*.test.ts?(x)']`
    - `setupFilesAfterEnv: ['<rootDir>/test/jest.setup.ts']`
    - `moduleNameMapper: { '\\.(css|less|scss)$': 'identity-obj-proxy' }`
    - `collectCoverage: true`
    - `collectCoverageFrom`: include `AssistantDashboard/**/*.{ts,tsx}`, exclude `AssistantDashboard/generated/**`, `AssistantDashboard/index.ts`
    - `coverageThreshold` with per-file glob pattern (`'./AssistantDashboard/**/*.{ts,tsx}'`) set to 80% for branches, functions, lines, statements

    **Note on `setupFilesAfterEnv`:** The correct Jest 29 config key is `setupFilesAfterEnv` (not the older `setupTestFrameworkScriptFile` from Jest <24). This key registers setup files that run after the test framework is installed in the environment, making Jest globals and matchers available.

    **Step 4 — Create `test/jest.setup.ts`:**
    - Import `@testing-library/jest-dom` (adds custom matchers like toBeInTheDocument)
    - Add `matchMedia` mock per Research pitfall #1:
    ```typescript
    import '@testing-library/jest-dom';

    // jsdom does not implement matchMedia. The App component's usePrefersDarkMode
    // hook calls window.matchMedia, which would throw without this mock.
    Object.defineProperty(window, 'matchMedia', {
      writable: true,
      value: jest.fn().mockImplementation(query => ({
        matches: false,
        media: query,
        onchange: null,
        addListener: jest.fn(),
        removeListener: jest.fn(),
        addEventListener: jest.fn(),
        removeEventListener: jest.fn(),
        dispatchEvent: jest.fn(),
      })),
    });
    ```
  </action>
  <verify>
    From `enterprise-work-assistant/src/`, run:
    ```bash
    npx jest --passWithNoTests
    ```
    Must exit 0 with "No tests found" (not a configuration error). Also verify `bun run test -- --passWithNoTests` works.
  </verify>
  <done>Jest runs without configuration errors. ts-jest compiles TypeScript. jsdom environment loads. jest-dom matchers available. matchMedia mock in place. Coverage collection configured with 80% per-file threshold.</done>
</task>

<task type="auto">
  <name>Task 2: Create ComponentFramework mock, renderWithProviders helper, and fixture data</name>
  <files>
    enterprise-work-assistant/src/test/mocks/componentFramework.ts
    enterprise-work-assistant/src/test/helpers/renderWithProviders.tsx
    enterprise-work-assistant/src/test/fixtures/cardFixtures.ts
  </files>
  <action>
    **Step 1 — Create `test/mocks/componentFramework.ts`:** Factory function per Research Pattern 2.
    - Export `MockRecordData` interface with `id: string`, `values: Record<string, string | number | null>`, optional `formattedValues?: Record<string, string>`
    - Export `createMockDataset(records: MockRecordData[])` that returns an object matching the `DataSet` interface in `useCardData.ts`:
      - `sortedRecordIds`: array of record IDs
      - `records`: map from ID to object with `getRecordId()`, `getValue(col)`, `getFormattedValue(col)` methods
    - Add JSDoc comments explaining WHY this mock exists: PCF virtual controls receive data through ComponentFramework.PropertyTypes.DataSet; useCardData defines its own DataSet/DataSetRecord interfaces that mirror this API; this mock satisfies those interfaces without the full PCF runtime

    **Step 2 — Create `test/helpers/renderWithProviders.tsx`:** Per Research Pattern 3.
    - Import FluentProvider and webLightTheme from `@fluentui/react-components`
    - Create Wrapper component that wraps children in `<FluentProvider theme={webLightTheme}>`
    - Export `renderWithProviders(ui, options?)` that calls RTL `render` with `wrapper: Wrapper`
    - Add JSDoc explaining that Fluent UI v9 components require FluentProvider ancestor for design token resolution

    **Step 3 — Create `test/fixtures/cardFixtures.ts`:** Per Research Pattern 4 and user decision.
    - Import `AssistantCard` type from `../../AssistantDashboard/components/types`
    - Export `tier1SkipItem: AssistantCard` — SKIP tier with `item_summary` as non-nullable string ("Marketing newsletter from Contoso Weekly — no action needed."), null priority/temporal_horizon/research_log/key_findings/verified_sources/confidence_score/draft_payload/humanized_draft, card_status "SUMMARY_ONLY"
    - Export `tier2LightItem: AssistantCard` — LIGHT tier with priority "Medium", temporal_horizon "THIS_WEEK", trigger_type "TEAMS_MESSAGE", null research_log, simple key_findings, null verified_sources/confidence_score/draft_payload/humanized_draft, card_status "SUMMARY_ONLY"
    - Export `tier3FullItem: AssistantCard` — FULL tier with all fields populated: priority "High", temporal_horizon "TODAY", research_log, key_findings with bullet points, verified_sources array with https URL, confidence_score 87, draft_payload as DraftPayload object, humanized_draft, card_status "READY"
    - Export `lowConfidenceItem: AssistantCard` — card_status "LOW_CONFIDENCE" with low_confidence_note populated
    - Export `calendarBriefingItem: AssistantCard` — trigger_type "CALENDAR_SCAN" with draft_payload as plain string (briefing text)
    - Export edge case mock dataset helpers:
      - `malformedJsonRecord: MockRecordData` — cr_fulljson contains invalid JSON
      - `validJsonRecord: MockRecordData` — cr_fulljson with a valid full-tier JSON string
      - `emptyDataset` — `{ sortedRecordIds: [], records: {} }`
    - All fixture data must be realistic — mirror actual Copilot Studio JSON output format per user decision
  </action>
  <verify>
    Verify files compile by running:
    ```bash
    npx tsc --project tsconfig.test.json --noEmit
    ```
    Check that imports resolve correctly and types match the AssistantCard interface.
  </verify>
  <done>ComponentFramework mock creates dataset objects matching useCardData's DataSet interface. renderWithProviders wraps components in FluentProvider. Fixture data covers all three triage tiers plus edge cases. All files compile without type errors.</done>
</task>

</tasks>

<verification>
1. `cd enterprise-work-assistant/src && npx jest --passWithNoTests` exits 0
2. `npx tsc --project tsconfig.test.json --noEmit` exits 0
3. `test/` directory contains: jest.config.ts, jest.setup.ts, mocks/componentFramework.ts, helpers/renderWithProviders.tsx, fixtures/cardFixtures.ts
4. package.json includes all test dependencies in devDependencies
5. tsconfig.test.json extends tsconfig.json with CommonJS module output
</verification>

<success_criteria>
- Jest configuration loads without errors
- ts-jest transforms TypeScript files using tsconfig.test.json
- jsdom environment provides browser globals (window, document)
- matchMedia mock prevents usePrefersDarkMode errors
- 80% per-file coverage threshold configured
- All shared test infrastructure files compile and export correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-infrastructure/08-01-SUMMARY.md`
</output>
