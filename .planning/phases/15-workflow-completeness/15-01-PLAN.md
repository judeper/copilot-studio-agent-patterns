---
phase: 15-workflow-completeness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - enterprise-work-assistant/schemas/dataverse-table.json
  - enterprise-work-assistant/prompts/orchestrator-agent-prompt.md
  - enterprise-work-assistant/docs/agent-flows.md
autonomous: true
requirements:
  - WKFL-01
  - WKFL-03

must_haves:
  truths:
    - "SELF_REMINDER cards created with a due date have a scheduled flow that queries them when overdue and surfaces them as active cards"
    - "The Trigger Type Compose expression in agent-flows.md maps all 6 trigger types to their correct Dataverse Choice values"
    - "The orchestrator prompt requires cr_reminderdue as a field when creating SELF_REMINDER cards"
  artifacts:
    - path: "enterprise-work-assistant/schemas/dataverse-table.json"
      provides: "cr_reminderdue DateTime column definition for reminders"
      contains: "cr_reminderdue"
    - path: "enterprise-work-assistant/prompts/orchestrator-agent-prompt.md"
      provides: "Updated CreateCard required fields including cr_reminderdue"
      contains: "cr_reminderdue"
    - path: "enterprise-work-assistant/docs/agent-flows.md"
      provides: "Flow 10 Reminder Firing spec + fixed Trigger Type Compose expression"
      contains: "Flow 10"
  key_links:
    - from: "enterprise-work-assistant/docs/agent-flows.md (Flow 10)"
      to: "enterprise-work-assistant/schemas/dataverse-table.json (cr_reminderdue)"
      via: "OData filter on cr_reminderdue le utcNow()"
      pattern: "cr_reminderdue"
    - from: "enterprise-work-assistant/docs/agent-flows.md (Trigger Type Compose)"
      to: "enterprise-work-assistant/schemas/dataverse-table.json (cr_triggertype options)"
      via: "Choice value mapping expression"
      pattern: "DAILY_BRIEFING.*100000003.*SELF_REMINDER.*100000004.*COMMAND_RESULT.*100000005"
---

<objective>
Complete the reminder firing workflow and fix trigger type coverage so all workflow paths have no dead ends.

Purpose: SELF_REMINDER cards can be created via the Orchestrator but currently have no mechanism to fire when due. The Trigger Type Compose expression only maps 3 of 6 types. Both are gaps identified in the v2.1 audit (I-31 and R-15/I-19).

Output: Updated Dataverse schema with cr_reminderdue column, updated orchestrator prompt, new Flow 10 spec for reminder firing, and corrected 6-value Trigger Type Compose expression.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@enterprise-work-assistant/schemas/dataverse-table.json
@enterprise-work-assistant/prompts/orchestrator-agent-prompt.md
@enterprise-work-assistant/docs/agent-flows.md

<interfaces>
From enterprise-work-assistant/schemas/dataverse-table.json — existing cr_triggertype Choice options:
- EMAIL → 100000000
- TEAMS_MESSAGE → 100000001
- CALENDAR_SCAN → 100000002
- DAILY_BRIEFING → 100000003
- SELF_REMINDER → 100000004
- COMMAND_RESULT → 100000005

From enterprise-work-assistant/docs/agent-flows.md — current Trigger Type Compose (line ~261):
```
if(equals(body('Parse_JSON')?['trigger_type'],'EMAIL'),100000000,if(equals(body('Parse_JSON')?['trigger_type'],'TEAMS_MESSAGE'),100000001,100000002))
```
This only maps EMAIL, TEAMS_MESSAGE, and defaults everything else to CALENDAR_SCAN (100000002). It must map all 6 values.

From enterprise-work-assistant/prompts/orchestrator-agent-prompt.md — CreateCard required fields (line ~86-91):
- cr_triggertype: 100000004 (SELF_REMINDER)
- cr_itemsummary: The reminder text
- cr_priority: Priority level
- cr_cardstatus: 100000000 (READY)
- cr_cardoutcome: 100000000 (PENDING)
Note: cr_reminderdue is NOT currently listed but must be added.

From enterprise-work-assistant/docs/agent-flows.md — existing flow numbering:
- Flow 1-3: Signal triggers (EMAIL, TEAMS, CALENDAR)
- Flow 4: Email Send
- Flow 5: Card Outcome Tracker
- Flow 6: Daily Briefing
- Flow 7: Staleness Monitor (actually labeled as Flow 7 in the naming table at line ~1937, but the section header says "Flow 7 — Staleness Monitor")
- Flow 8: Command Execution (section header says "Flow 8 — Command Execution")
- Flow 9: Sender Profile Analyzer

Naming table at end of agent-flows.md (line ~1933-1938):
| Flow 4 | "Flow 4: Email Send" |
| Flow 5 | "Flow 5: Card Outcome Tracker" |
| Flow 6 | "Flow 6: Daily Briefing" |
| Flow 7 | "Flow 7: Command Execution" |
| Flow 8 | "Flow 8: Staleness Monitor" |
| Flow 9 | "Flow 9: Sender Profile Analyzer" |

Note: The section headers show Flow 7 as Staleness Monitor and Flow 8 as Command Execution, but the naming table shows the reverse. The new flow should be Flow 10.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cr_reminderdue column and update orchestrator prompt</name>
  <files>
    enterprise-work-assistant/schemas/dataverse-table.json
    enterprise-work-assistant/prompts/orchestrator-agent-prompt.md
  </files>
  <action>
    **1. Add cr_reminderdue column to dataverse-table.json**

    Add a new column entry after the existing `cr_sourcesignalid` column (the last column in the array):

    ```json
    {
      "logicalName": "cr_reminderdue",
      "displayName": "Reminder Due",
      "type": "DateTime",
      "required": false,
      "description": "When this reminder should fire. Only populated for SELF_REMINDER trigger type cards. The Reminder Firing flow (Flow 10) queries cards where this date is in the past."
    }
    ```

    This column is nullable (required: false) because only SELF_REMINDER cards use it. All other trigger types leave it null.

    **2. Update orchestrator-agent-prompt.md CreateCard section**

    In the "Required fields for reminders" list (around line 86-91), add `cr_reminderdue` as a required field:

    ```
    **Required fields for reminders:**
    - `cr_triggertype`: 100000004 (SELF_REMINDER)
    - `cr_itemsummary`: The reminder text
    - `cr_reminderdue`: ISO 8601 datetime string for when the reminder should fire (e.g., "2026-03-07T09:00:00Z")
    - `cr_priority`: Priority level
    - `cr_cardstatus`: 100000000 (READY)
    - `cr_cardoutcome`: 100000000 (PENDING)
    ```

    Also update the guardrail on line ~205 that says "Do NOT create reminders in the past" to:
    ```
    - Do NOT create reminders in the past. Always set cr_reminderdue to a future datetime.
    ```
  </action>
  <verify>
    <automated>grep -c "cr_reminderdue" enterprise-work-assistant/schemas/dataverse-table.json enterprise-work-assistant/prompts/orchestrator-agent-prompt.md</automated>
  </verify>
  <done>dataverse-table.json contains cr_reminderdue column definition. orchestrator-agent-prompt.md lists cr_reminderdue as required for SELF_REMINDER cards.</done>
</task>

<task type="auto">
  <name>Task 2: Add Flow 10 Reminder Firing spec and fix Trigger Type Compose expression</name>
  <files>
    enterprise-work-assistant/docs/agent-flows.md
  </files>
  <action>
    **1. Fix the Trigger Type Compose expression (WKFL-03)**

    Find the current Trigger Type Compose expression (around line 258-262):
    ```
    **Compose -- Trigger Type Value:**

    ```
    if(equals(body('Parse_JSON')?['trigger_type'],'EMAIL'),100000000,if(equals(body('Parse_JSON')?['trigger_type'],'TEAMS_MESSAGE'),100000001,100000002))
    ```
    ```

    Replace it with a full 6-value mapping:
    ```
    **Compose -- Trigger Type Value:**

    ```
    if(equals(body('Parse_JSON')?['trigger_type'],'EMAIL'),100000000,if(equals(body('Parse_JSON')?['trigger_type'],'TEAMS_MESSAGE'),100000001,if(equals(body('Parse_JSON')?['trigger_type'],'CALENDAR_SCAN'),100000002,if(equals(body('Parse_JSON')?['trigger_type'],'DAILY_BRIEFING'),100000003,if(equals(body('Parse_JSON')?['trigger_type'],'SELF_REMINDER'),100000004,if(equals(body('Parse_JSON')?['trigger_type'],'COMMAND_RESULT'),100000005,100000002))))))
    ```

    > **Note**: This expression maps all 6 trigger types to their Dataverse Choice values. The final fallback (100000002 / CALENDAR_SCAN) handles any unexpected values defensively. Flows 1-3 hardcode their trigger type via the agent input variable, so the parsed output will always match one of the 6 values. Flows 6 and 8 write directly with literal Choice values and do not use this Compose action. Flow 10 (Reminder Firing) also writes directly with a literal value.
    ```

    **2. Add Flow 10 — Reminder Firing spec (WKFL-01)**

    Add a new section before the "---" separator that precedes the "Operational Notes" or solution packaging section at the end of agent-flows.md. The new section should be added after Flow 9 — Sender Profile Analyzer (which ends around line 1830), before the "## Solution Packaging" or "## Deployment Checklist" section.

    Insert the following Flow 10 specification:

    ```markdown
    ---

    ## Flow 10 — Reminder Firing *(Phase 15)*

    ### Overview

    Scheduled flow that checks for SELF_REMINDER cards whose due date has passed. When a reminder is due, the flow updates the card's status to NUDGE so it surfaces prominently in the user's dashboard. This completes the reminder lifecycle: the Orchestrator creates SELF_REMINDER cards with a future cr_reminderdue date, and this flow fires them when the time arrives.

    ### Trigger

    **Recurrence** — Schedule connector

    | Setting | Value |
    |---------|-------|
    | Frequency | Minute |
    | Interval | 15 |

    > **Design note**: A 15-minute interval balances timeliness (reminders fire within 15 minutes of their due time) against flow run consumption. Adjust based on your Power Automate plan's run quota. For daily reminders, an hourly interval is sufficient; for time-sensitive reminders, consider 5 minutes.

    ### Actions

    **1. List due reminders** — Dataverse connector → List rows

    | Setting | Value |
    |---------|-------|
    | Table name | Assistant Cards |
    | Filter rows | `cr_triggertype eq 100000004 and cr_cardoutcome eq 100000000 and cr_reminderdue le @{utcNow()} and cr_cardstatus ne 100000004` |
    | Sort by | `cr_reminderdue asc` |
    | Row count | `50` |
    | Select columns | `cr_assistantcardid,cr_itemsummary,cr_reminderdue,cr_priority,_ownerid_value` |

    > The filter selects SELF_REMINDER cards (trigger type 100000004) that are still PENDING (outcome 100000000), have a due date in the past (`cr_reminderdue le utcNow()`), and have NOT already been nudged (card status is not NUDGE / 100000004). This prevents re-nudging cards that have already fired.

    **2. Condition — Has due reminders**

    ```
    @greater(length(outputs('List_due_reminders')?['body/value']), 0)
    ```

    **If No:** Terminate (no action needed).

    **If Yes:**

    **3. Apply to each** — Loop over due reminders

    For each due reminder card:

    **3a. Update card status to NUDGE** — Dataverse connector → Update a row

    | Setting | Value |
    |---------|-------|
    | Table name | Assistant Cards |
    | Row ID | `@{items('Apply_to_each')?['cr_assistantcardid']}` |
    | Card Status | `100000004` *(NUDGE)* |
    | Priority | `100000000` *(High — override to High when reminder fires)* |

    > When the card status changes to NUDGE, the PCF dashboard's Canvas App Timer triggers a Dataverse refresh within 30 seconds. The NUDGE status renders the card with visual emphasis in the card gallery, identical to how the Staleness Monitor (Flow 7) surfaces overdue items.

    **3b. Compose — Notification summary** (optional)

    ```
    Reminder fired: @{items('Apply_to_each')?['cr_itemsummary']} (due @{items('Apply_to_each')?['cr_reminderdue']})
    ```

    > This Compose is for optional notification or audit logging. If your organization uses Teams notifications, add a "Post message in a chat or channel" action here to send the reminder text to the user.

    ### Error Handling

    Wrap steps 1-3 in a **Scope** with "Run after: has failed" parallel branch. Log the error to the admin notification email (same pattern as other flows).

    ### Flow Diagram

    ```
    Trigger (Recurrence — every 15 minutes)
      │
      ├── 1. List SELF_REMINDER cards where cr_reminderdue <= now() and status != NUDGE
      ├── 2. Has due reminders?
      │   ├── No → Terminate
      │   └── Yes → 3. Apply to each
      │       ├── 3a. Update card status to NUDGE + priority to High
      │       └── 3b. (Optional) Compose notification summary
      └── (on failure) → Error handling scope
    ```

    ### Deployment Checklist

    - [ ] cr_reminderdue column added to Assistant Cards table (run updated `provision-environment.ps1`)
    - [ ] Flow created with 15-minute recurrence trigger
    - [ ] Dataverse filter correctly targets SELF_REMINDER + PENDING + past due date + not already NUDGE
    - [ ] Card status update sets NUDGE (100000004) and Priority to High (100000000)
    - [ ] Error handling scope configured with admin notification
    - [ ] Test: Create SELF_REMINDER card with cr_reminderdue 1 minute in the future, wait for flow run, verify card status changes to NUDGE
    - [ ] Test: SELF_REMINDER card with future cr_reminderdue is NOT nudged
    - [ ] Test: Already-nudged SELF_REMINDER card is NOT re-nudged
    ```

    **3. Update the flow naming table**

    Find the naming convention table near the end of agent-flows.md (around line 1933-1938) and add Flow 10:

    ```
    | Flow 10 | "Flow 10: Reminder Firing" |
    ```

    **4. Update the introductory paragraph**

    The first paragraph of agent-flows.md (line 3) says "nine Power Automate flows". Update this to "ten Power Automate flows" and add "reminder firing" to the list of flow purposes:
    ```
    ...email sending, outcome tracking, daily briefings, staleness monitoring, command execution, sender analytics, and reminder firing.
    ```
  </action>
  <verify>
    <automated>grep -c "DAILY_BRIEFING.*100000003" enterprise-work-assistant/docs/agent-flows.md && grep -c "Flow 10" enterprise-work-assistant/docs/agent-flows.md && grep -c "cr_reminderdue" enterprise-work-assistant/docs/agent-flows.md</automated>
  </verify>
  <done>The Trigger Type Compose expression maps all 6 trigger types. Flow 10 Reminder Firing spec exists with trigger, filter, actions, error handling, flow diagram, and deployment checklist. Flow naming table includes Flow 10.</done>
</task>

</tasks>

<verification>
1. `grep "cr_reminderdue" enterprise-work-assistant/schemas/dataverse-table.json` — column defined in Dataverse schema
2. `grep "cr_reminderdue" enterprise-work-assistant/prompts/orchestrator-agent-prompt.md` — required field in orchestrator prompt
3. `grep "DAILY_BRIEFING.*100000003" enterprise-work-assistant/docs/agent-flows.md` — Trigger Type Compose maps DAILY_BRIEFING
4. `grep "SELF_REMINDER.*100000004" enterprise-work-assistant/docs/agent-flows.md` — Trigger Type Compose maps SELF_REMINDER
5. `grep "COMMAND_RESULT.*100000005" enterprise-work-assistant/docs/agent-flows.md` — Trigger Type Compose maps COMMAND_RESULT
6. `grep "Flow 10" enterprise-work-assistant/docs/agent-flows.md` — Flow 10 section exists
7. `grep "ten Power Automate flows" enterprise-work-assistant/docs/agent-flows.md` — intro paragraph updated
</verification>

<success_criteria>
- cr_reminderdue DateTime column exists in dataverse-table.json with description linking it to Flow 10
- orchestrator-agent-prompt.md lists cr_reminderdue as required for SELF_REMINDER card creation
- Trigger Type Compose expression in agent-flows.md maps all 6 values: EMAIL→100000000, TEAMS_MESSAGE→100000001, CALENDAR_SCAN→100000002, DAILY_BRIEFING→100000003, SELF_REMINDER→100000004, COMMAND_RESULT→100000005
- Flow 10 Reminder Firing spec has: recurrence trigger, OData filter on cr_triggertype/cr_cardoutcome/cr_reminderdue/cr_cardstatus, NUDGE update action, error handling, deployment checklist
- Flow naming table includes Flow 10
</success_criteria>

<output>
After completion, create `.planning/phases/15-workflow-completeness/15-01-SUMMARY.md`
</output>
