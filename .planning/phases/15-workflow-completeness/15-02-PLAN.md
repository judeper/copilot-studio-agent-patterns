---
phase: 15-workflow-completeness
plan: 02
type: execute
wave: 2
depends_on:
  - 15-01
files_modified:
  - enterprise-work-assistant/schemas/briefingschedule-table.json
  - enterprise-work-assistant/docs/agent-flows.md
  - enterprise-work-assistant/docs/canvas-app-setup.md
  - enterprise-work-assistant/docs/deployment-guide.md
  - enterprise-work-assistant/scripts/provision-environment.ps1
autonomous: true
requirements:
  - WKFL-02

must_haves:
  truths:
    - "A BriefingSchedule Dataverse table exists with columns for user, schedule hour, schedule days, timezone, and enabled flag"
    - "The Canvas App setup guide includes instructions for adding a briefing schedule configuration panel"
    - "Flow 6 (Daily Briefing) reads the user's schedule from the BriefingSchedule table at execution time instead of using a hardcoded recurrence"
    - "The provisioning script creates the BriefingSchedule table"
  artifacts:
    - path: "enterprise-work-assistant/schemas/briefingschedule-table.json"
      provides: "BriefingSchedule Dataverse table definition"
      contains: "cr_briefingschedule"
    - path: "enterprise-work-assistant/docs/agent-flows.md"
      provides: "Updated Flow 6 that reads schedule from Dataverse"
      contains: "BriefingSchedule"
    - path: "enterprise-work-assistant/docs/canvas-app-setup.md"
      provides: "Briefing schedule configuration UI instructions"
      contains: "BriefingSchedule"
    - path: "enterprise-work-assistant/docs/deployment-guide.md"
      provides: "Updated deployment guidance referencing BriefingSchedule table"
      contains: "BriefingSchedule"
    - path: "enterprise-work-assistant/scripts/provision-environment.ps1"
      provides: "BriefingSchedule table creation commands"
      contains: "cr_briefingschedule"
  key_links:
    - from: "enterprise-work-assistant/docs/agent-flows.md (Flow 6)"
      to: "enterprise-work-assistant/schemas/briefingschedule-table.json"
      via: "Dataverse List rows query for user schedule"
      pattern: "cr_briefingschedule"
    - from: "enterprise-work-assistant/docs/canvas-app-setup.md"
      to: "enterprise-work-assistant/schemas/briefingschedule-table.json"
      via: "Canvas App Patch() formula writes schedule to Dataverse"
      pattern: "Patch.*BriefingSchedule"
---

<objective>
Add a Dataverse BriefingSchedule table for persistent schedule configuration and update the Daily Briefing flow to read the user's schedule at execution time.

Purpose: Tech debt #13 (R-35) — the briefing schedule was stored in component state (lost on refresh). This plan creates the dedicated Dataverse table, updates Flow 6 to use it, adds Canvas App UI instructions, and updates the provisioning script.

Output: BriefingSchedule table schema, updated Flow 6 spec, Canvas App setup instructions for schedule configuration, updated deployment guide and provisioning script.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@enterprise-work-assistant/schemas/dataverse-table.json
@enterprise-work-assistant/schemas/senderprofile-table.json
@enterprise-work-assistant/docs/agent-flows.md
@enterprise-work-assistant/docs/canvas-app-setup.md
@enterprise-work-assistant/docs/deployment-guide.md
@enterprise-work-assistant/scripts/provision-environment.ps1

<interfaces>
From enterprise-work-assistant/docs/agent-flows.md — Current Flow 6 trigger (line ~1057-1066):
```markdown
**Recurrence** — Schedule connector

| Setting | Value |
|---------|-------|
| Frequency | Week |
| Interval | 1 |
| Days | Monday, Tuesday, Wednesday, Thursday, Friday |
| At These Hours | 7 |
| At These Minutes | 0 |
| Time Zone | Select appropriate timezone for the user |
```
This is a hardcoded schedule. The requirement is to make it configurable per-user via a Dataverse table.

From enterprise-work-assistant/docs/deployment-guide.md — current BriefingScheduleTime config (line ~303):
```
| `BriefingScheduleTime` | Text | Cron expression for Daily Briefing flow recurrence | `0 7 * * 1-5` (weekdays at 7 AM) |
```

From enterprise-work-assistant/schemas/senderprofile-table.json — existing table schema pattern to follow:
The senderprofile-table.json is a good reference for how Dataverse table schemas are documented in this project.

From enterprise-work-assistant/src/AssistantDashboard/components/BriefingCard.tsx (line ~126-128):
```typescript
// TODO: Schedule configuration deferred to post-v2.1 milestone
// The Daily Briefing flow (Flow 6) uses a fixed Power Automate recurrence trigger.
// User-configurable scheduling requires a dedicated Dataverse table and UI.
```
This TODO marker should be updated (but BriefingCard.tsx React changes are deferred to Phase 16 Fluent UI migration — this plan only covers the Dataverse/Flow/Canvas layers).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BriefingSchedule Dataverse table schema and update provisioning</name>
  <files>
    enterprise-work-assistant/schemas/briefingschedule-table.json
    enterprise-work-assistant/scripts/provision-environment.ps1
    enterprise-work-assistant/docs/deployment-guide.md
  </files>
  <action>
    **1. Create briefingschedule-table.json**

    Create a new Dataverse table definition following the same JSON format as `senderprofile-table.json` and `dataverse-table.json`. The table stores per-user briefing schedule preferences.

    ```json
    {
      "tableName": "cr_briefingschedule",
      "entitySetName": "cr_briefingschedules",
      "displayName": "Briefing Schedules",
      "pluralName": "Briefing Schedules",
      "description": "Stores per-user Daily Briefing schedule preferences. Each user has at most one row. The Daily Briefing flow (Flow 6) reads this table to determine when and whether to generate a briefing for each user.",
      "primaryColumn": "cr_userdisplayname",
      "ownershipType": "UserOwned",
      "columns": [
        {
          "logicalName": "cr_userdisplayname",
          "displayName": "User Display Name",
          "type": "Text",
          "maxLength": 200,
          "required": true,
          "description": "Display name of the user. Serves as the primary column for readability in the Dataverse UI."
        },
        {
          "logicalName": "cr_schedulehour",
          "displayName": "Schedule Hour",
          "type": "WholeNumber",
          "minValue": 0,
          "maxValue": 23,
          "required": true,
          "description": "Hour of day (0-23) when the briefing should be generated. Default: 7 (7 AM)."
        },
        {
          "logicalName": "cr_scheduleminute",
          "displayName": "Schedule Minute",
          "type": "WholeNumber",
          "minValue": 0,
          "maxValue": 59,
          "required": true,
          "description": "Minute of hour (0-59) when the briefing should be generated. Default: 0."
        },
        {
          "logicalName": "cr_scheduledays",
          "displayName": "Schedule Days",
          "type": "Text",
          "maxLength": 100,
          "required": true,
          "description": "Comma-separated list of days when the briefing runs. Values: Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday. Default: 'Monday,Tuesday,Wednesday,Thursday,Friday'."
        },
        {
          "logicalName": "cr_timezone",
          "displayName": "Time Zone",
          "type": "Text",
          "maxLength": 100,
          "required": true,
          "description": "IANA timezone string for schedule evaluation (e.g., 'America/New_York', 'Europe/London'). Default: user's AAD timezone."
        },
        {
          "logicalName": "cr_isenabled",
          "displayName": "Is Enabled",
          "type": "TwoOption",
          "required": true,
          "description": "Whether the daily briefing is active for this user. Default: true. Set to false to pause briefings without deleting the schedule."
        }
      ],
      "notes": {
        "design_rationale": "One row per user. The Owner field (standard Dataverse system column) links the schedule to the user. The flow runs on a frequent recurrence (every 15 minutes) and checks if any user's scheduled time has arrived, rather than relying on a per-user recurrence trigger.",
        "scheduling_approach": "The flow runs frequently and compares the current time against each user's cr_schedulehour/cr_scheduleminute/cr_scheduledays/cr_timezone. This avoids the need for per-user Power Automate flows (which don't scale) while still supporting per-user schedules.",
        "default_behavior": "If a user has no row in this table, the flow uses the default schedule (weekdays at 7 AM in the flow's configured timezone). This preserves backward compatibility with existing deployments."
      }
    }
    ```

    **2. Update provision-environment.ps1**

    Find the section where Dataverse tables are created (after the SenderProfile table creation). Add the BriefingSchedule table creation commands following the same PAC CLI pattern used for the existing tables. Add the table creation and column commands:

    ```powershell
    # --- BriefingSchedule Table ---
    Write-Host "`n--- Creating Briefing Schedules Table ---" -ForegroundColor Cyan

    pac table create --name "cr_briefingschedule" --display-name "Briefing Schedules" --description "Per-user Daily Briefing schedule preferences" --primary-column-name "cr_userdisplayname" --primary-column-display-name "User Display Name"

    pac table column create --table "cr_briefingschedule" --name "cr_schedulehour" --display-name "Schedule Hour" --type "WholeNumber" --required "true"
    pac table column create --table "cr_briefingschedule" --name "cr_scheduleminute" --display-name "Schedule Minute" --type "WholeNumber" --required "true"
    pac table column create --table "cr_briefingschedule" --name "cr_scheduledays" --display-name "Schedule Days" --type "Text" --max-length 100 --required "true"
    pac table column create --table "cr_briefingschedule" --name "cr_timezone" --display-name "Time Zone" --type "Text" --max-length 100 --required "true"
    pac table column create --table "cr_briefingschedule" --name "cr_isenabled" --display-name "Is Enabled" --type "TwoOption" --required "true"
    ```

    Also add the cr_reminderdue column creation from Plan 15-01 to the Assistant Cards table section (if not already present):

    ```powershell
    pac table column create --table "cr_assistantcard" --name "cr_reminderdue" --display-name "Reminder Due" --type "DateTime" --required "false"
    ```

    **3. Update deployment-guide.md**

    Find the `BriefingScheduleTime` row in the environment variables table (around line 303). Replace it with a note that briefing schedules are now per-user via the BriefingSchedule table:

    Replace:
    ```
    | `BriefingScheduleTime` | Text | Cron expression for Daily Briefing flow recurrence | `0 7 * * 1-5` (weekdays at 7 AM) |
    ```

    With:
    ```
    | ~~`BriefingScheduleTime`~~ | ~~Text~~ | Replaced by the BriefingSchedule Dataverse table. Each user configures their schedule via the Canvas App UI. The Daily Briefing flow (Flow 6) checks the table every 15 minutes. Default for users without a schedule row: weekdays at 7 AM. | See `schemas/briefingschedule-table.json` |
    ```
  </action>
  <verify>
    <automated>test -f enterprise-work-assistant/schemas/briefingschedule-table.json && grep -c "cr_briefingschedule" enterprise-work-assistant/scripts/provision-environment.ps1 && grep -c "BriefingSchedule" enterprise-work-assistant/docs/deployment-guide.md</automated>
  </verify>
  <done>briefingschedule-table.json exists with 6 columns. provision-environment.ps1 creates the table. deployment-guide.md references BriefingSchedule table instead of cron expression.</done>
</task>

<task type="auto">
  <name>Task 2: Update Flow 6 to read schedule from Dataverse and add Canvas App UI instructions</name>
  <files>
    enterprise-work-assistant/docs/agent-flows.md
    enterprise-work-assistant/docs/canvas-app-setup.md
  </files>
  <action>
    **1. Update Flow 6 in agent-flows.md**

    The current Flow 6 trigger is a weekly recurrence (weekdays at 7 AM). Replace it with a more frequent recurrence that checks user schedules from the BriefingSchedule table.

    Find the Flow 6 trigger section (around line 1055-1066). Replace the trigger AND add new pre-steps:

    **Replace the Trigger section** with:
    ```markdown
    ### Trigger

    **Recurrence** — Schedule connector

    | Setting | Value |
    |---------|-------|
    | Frequency | Minute |
    | Interval | 15 |

    > **Design change (Phase 15)**: The trigger now runs every 15 minutes instead of at a fixed weekly time. The flow checks the BriefingSchedule Dataverse table to determine which users need a briefing at the current time. This enables per-user schedule configuration without requiring separate flows per user.
    ```

    **Add new pre-steps** before the existing "1. Get my profile (V2)" step. Renumber existing steps accordingly (existing 1-9 become 4-12):

    ```markdown
    ### Actions

    **1. List active briefing schedules** — Dataverse connector → List rows

    | Setting | Value |
    |---------|-------|
    | Table name | Briefing Schedules |
    | Filter rows | `cr_isenabled eq true` |
    | Row count | `100` |
    | Select columns | `cr_briefingscheduleid,cr_userdisplayname,cr_schedulehour,cr_scheduleminute,cr_scheduledays,cr_timezone,_ownerid_value` |

    **2. Apply to each** — Loop over active schedules

    For each schedule row, check if the current time matches the user's configured schedule.

    **2a. Compose — CURRENT_TIME_IN_USER_TZ**

    Convert UTC now to the user's timezone:
    ```
    @{convertTimeZone(utcNow(), 'UTC', items('Apply_to_each')?['cr_timezone'], 'HH:mm')}
    ```

    **2b. Compose — CURRENT_DAY_IN_USER_TZ**

    Get the current day name in the user's timezone:
    ```
    @{convertTimeZone(utcNow(), 'UTC', items('Apply_to_each')?['cr_timezone'], 'dddd')}
    ```

    **2c. Condition — Is it time for this user's briefing?**

    Check if (a) the current hour:minute is within the 15-minute window of the user's schedule, (b) today is one of their scheduled days, and (c) a briefing hasn't already been generated today:

    ```
    @and(
        equals(int(first(split(outputs('Compose_CURRENT_TIME_IN_USER_TZ'), ':'))), items('Apply_to_each')?['cr_schedulehour']),
        less(int(last(split(outputs('Compose_CURRENT_TIME_IN_USER_TZ'), ':'))), add(items('Apply_to_each')?['cr_scheduleminute'], 15)),
        greaterOrEquals(int(last(split(outputs('Compose_CURRENT_TIME_IN_USER_TZ'), ':'))), items('Apply_to_each')?['cr_scheduleminute']),
        contains(items('Apply_to_each')?['cr_scheduledays'], outputs('Compose_CURRENT_DAY_IN_USER_TZ'))
    )
    ```

    > **Deduplication**: To prevent duplicate briefings if the flow triggers multiple times in the 15-minute window, add a guard step (step 2d below) that checks if today's briefing already exists for this user.

    **2d. List today's briefings for user** — Dataverse connector → List rows

    | Setting | Value |
    |---------|-------|
    | Table name | Assistant Cards |
    | Filter rows | `cr_triggertype eq 100000003 and _ownerid_value eq '@{items('Apply_to_each')?['_ownerid_value']}' and createdon ge @{startOfDay(convertTimeZone(utcNow(), 'UTC', items('Apply_to_each')?['cr_timezone']))}` |
    | Row count | `1` |

    **2e. Condition — Briefing not already generated today**

    ```
    @equals(length(outputs('List_todays_briefings_for_user')?['body/value']), 0)
    ```

    **If Yes (no briefing yet today):** Proceed with steps 3-12 (the original Flow 6 logic, now renumbered).

    **If No:** Skip — briefing already exists for this user today.
    ```

    **Update the existing step numbering**: The original steps 1-9 become steps 3-11 inside the "If Yes" branch:
    - Original step 1 "Get my profile (V2)" → Step 3 (but now uses the schedule's `_ownerid_value` to get the user profile instead of the flow runner's profile)
    - Original steps 2-9 → Steps 4-11

    Update step 3 note:
    ```markdown
    **3. Get user profile** — Office 365 Users → Get user profile (V2)

    Use the schedule owner's user ID from the BriefingSchedule row:
    ```
    @{items('Apply_to_each')?['_ownerid_value']}
    ```

    > **Multi-user note (Phase 15)**: In the original Flow 6 design, the flow ran under a single user's identity using "Get my profile." With the BriefingSchedule table, the flow iterates over all users with active schedules. This requires the flow's service account to have **read** access to each user's Assistant Cards and Sender Profiles via Dataverse security roles. Ensure the flow connection uses a service account with appropriate permissions, or run the flow with the "Run as" option set to each row's owner.
    ```

    **Update the Flow Diagram** for Flow 6 to reflect the new schedule-aware structure:
    ```markdown
    ### Flow Diagram

    ```
    Trigger (Recurrence — every 15 minutes)
      │
      ├── 1. List active briefing schedules from Dataverse
      └── 2. Apply to each schedule
          ├── 2a. Convert current time to user's timezone
          ├── 2b. Get current day in user's timezone
          ├── 2c. Is it time for this user's briefing?
          │   └── No → Skip
          ├── 2d. Check if briefing already generated today
          ├── 2e. Briefing not already generated?
          │   ├── No → Skip (already generated)
          │   └── Yes → Generate briefing
          │       ├── 3. Get user profile
          │       ├── 4. List open cards (for this user)
          │       ├── 5. Token budget guard
          │       ├── 6. List stale cards
          │       ├── 7. Get today's calendar
          │       ├── 8. List sender profiles
          │       ├── 9. Compose BRIEFING_INPUT
          │       ├── 10. Invoke Daily Briefing Agent
          │       ├── 11. Parse JSON + Write DAILY_BRIEFING card
          │       └── (on failure) → Error handling scope
    ```
    ```

    **2. Add briefing schedule configuration section to canvas-app-setup.md**

    Add a new section after the existing Canvas App setup content (before any final notes). Insert after the PCF wiring sections. Title it "## Briefing Schedule Configuration" and include:

    ```markdown
    ## Briefing Schedule Configuration

    The Daily Briefing schedule is stored in the `Briefing Schedules` Dataverse table, allowing each user to configure when they receive their daily briefing.

    ### 1. Add Data Source

    1. In the left panel, click **Data** → **Add data**
    2. Search for **Dataverse**
    3. Select the **Briefing Schedules** table
    4. Click **Connect**

    ### 2. Add Schedule Configuration Controls

    Create a new screen or panel (e.g., `scrSettings`) for schedule configuration:

    **Schedule Hour Dropdown**
    - **Name**: `drpBriefingHour`
    - **Items**: `Sequence(24, 0)` *(generates 0-23)*
    - **Default**: `7`
    - **DisplayMode**: `DisplayMode.Edit`

    **Schedule Minute Dropdown**
    - **Name**: `drpBriefingMinute`
    - **Items**: `[0, 15, 30, 45]`
    - **Default**: `0`

    **Schedule Days Checkboxes**

    Add seven Checkbox controls, one per day:
    - **Names**: `chkMon`, `chkTue`, `chkWed`, `chkThu`, `chkFri`, `chkSat`, `chkSun`
    - **Default (weekdays)**: `chkMon.Default = true`, ..., `chkFri.Default = true`, `chkSat.Default = false`, `chkSun.Default = false`

    **Timezone Dropdown**
    - **Name**: `drpTimezone`
    - **Items**: `["America/New_York", "America/Chicago", "America/Denver", "America/Los_Angeles", "Europe/London", "Europe/Paris", "Europe/Berlin", "Asia/Tokyo", "Asia/Shanghai", "Australia/Sydney"]`
    - **Default**: `"America/New_York"`

    > **Tip**: Customize the timezone list for your organization's locations. The full IANA timezone list is available at [Wikipedia: List of tz database time zones](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones).

    **Enabled Toggle**
    - **Name**: `tglBriefingEnabled`
    - **Default**: `true`

    **Save Button**
    - **Name**: `btnSaveBriefingSchedule`
    - **Text**: `"Save Schedule"`
    - **OnSelect**:

    ```
    Patch(
        'Briefing Schedules',
        Defaults('Briefing Schedules'),
        {
            'User Display Name': User().FullName,
            'Schedule Hour': drpBriefingHour.Selected.Value,
            'Schedule Minute': drpBriefingMinute.Selected.Value,
            'Schedule Days': Concat(
                Filter(
                    Table(
                        {day: "Monday", checked: chkMon.Value},
                        {day: "Tuesday", checked: chkTue.Value},
                        {day: "Wednesday", checked: chkWed.Value},
                        {day: "Thursday", checked: chkThu.Value},
                        {day: "Friday", checked: chkFri.Value},
                        {day: "Saturday", checked: chkSat.Value},
                        {day: "Sunday", checked: chkSun.Value}
                    ),
                    checked
                ),
                day,
                ","
            ),
            'Time Zone': drpTimezone.Selected.Value,
            'Is Enabled': tglBriefingEnabled.Value,
            Owner: LookUp(Users, 'Primary Email' = User().Email)
        }
    )
    ```

    > **Note**: The `Patch` with `Defaults()` creates a new row. To update an existing schedule, first look up the user's existing row and pass it as the second argument instead of `Defaults()`. A more robust pattern:

    ```
    // On screen load, check for existing schedule
    Set(
        varMySchedule,
        LookUp(
            'Briefing Schedules',
            Owner.'Primary Email' = User().Email
        )
    );

    // In Save button OnSelect, use upsert pattern
    Patch(
        'Briefing Schedules',
        If(
            IsBlank(varMySchedule),
            Defaults('Briefing Schedules'),
            varMySchedule
        ),
        { /* fields as above */ }
    )
    ```

    ### 3. Load Existing Schedule on Screen Load

    Set the `OnVisible` property of the settings screen:

    ```
    Set(
        varMySchedule,
        LookUp(
            'Briefing Schedules',
            Owner.'Primary Email' = User().Email
        )
    );

    // Pre-populate controls if schedule exists
    If(
        !IsBlank(varMySchedule),
        UpdateContext({
            locHour: varMySchedule.'Schedule Hour',
            locMinute: varMySchedule.'Schedule Minute',
            locTimezone: varMySchedule.'Time Zone',
            locEnabled: varMySchedule.'Is Enabled'
        })
    )
    ```

    Set each dropdown's `Default` to the loaded value (e.g., `drpBriefingHour.Default = If(!IsBlank(varMySchedule), varMySchedule.'Schedule Hour', 7)`).
    ```
  </action>
  <verify>
    <automated>test -f enterprise-work-assistant/schemas/briefingschedule-table.json && grep -c "BriefingSchedule\|Briefing Schedule" enterprise-work-assistant/docs/agent-flows.md && grep -c "BriefingSchedule\|Briefing Schedule" enterprise-work-assistant/docs/canvas-app-setup.md</automated>
  </verify>
  <done>BriefingSchedule table schema exists. Flow 6 reads user schedule from Dataverse with timezone-aware time matching and deduplication. Canvas App setup guide includes schedule configuration panel instructions with Patch formula. Deployment guide references BriefingSchedule table. Provisioning script creates the table.</done>
</task>

</tasks>

<verification>
1. `cat enterprise-work-assistant/schemas/briefingschedule-table.json | python3 -m json.tool > /dev/null` — valid JSON
2. `grep "cr_schedulehour" enterprise-work-assistant/schemas/briefingschedule-table.json` — schedule hour column defined
3. `grep "cr_isenabled" enterprise-work-assistant/schemas/briefingschedule-table.json` — enabled flag column defined
4. `grep "Briefing Schedule" enterprise-work-assistant/docs/agent-flows.md` — Flow 6 references BriefingSchedule table
5. `grep "every 15 minutes" enterprise-work-assistant/docs/agent-flows.md` — Flow 6 trigger updated to frequent recurrence
6. `grep "Patch" enterprise-work-assistant/docs/canvas-app-setup.md` — Canvas App save formula exists
7. `grep "cr_briefingschedule" enterprise-work-assistant/scripts/provision-environment.ps1` — provisioning creates table
8. `grep "BriefingSchedule" enterprise-work-assistant/docs/deployment-guide.md` — deployment guide updated
</verification>

<success_criteria>
- briefingschedule-table.json exists with columns: cr_userdisplayname, cr_schedulehour, cr_scheduleminute, cr_scheduledays, cr_timezone, cr_isenabled
- Flow 6 trigger changed from weekly recurrence to 15-minute recurrence
- Flow 6 includes steps to: list active schedules, check current time against user timezone, deduplicate (check if briefing already generated today), then generate briefing
- Canvas App setup guide includes: data source connection, schedule controls (hour, minute, days, timezone, enabled), Patch formula, load existing schedule pattern
- Provisioning script creates BriefingSchedule table with all columns
- Deployment guide references BriefingSchedule table instead of hardcoded cron expression
</success_criteria>

<output>
After completion, create `.planning/phases/15-workflow-completeness/15-02-SUMMARY.md`
</output>
