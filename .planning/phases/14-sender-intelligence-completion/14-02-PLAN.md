---
phase: 14-sender-intelligence-completion
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - enterprise-work-assistant/docs/agent-flows.md
  - enterprise-work-assistant/docs/deployment-guide.md
autonomous: true
requirements:
  - SNDR-01
  - SNDR-02
  - SNDR-03

must_haves:
  truths:
    - "All 3 trigger flows (Email, Teams, Calendar) look up the sender profile and pass SENDER_PROFILE JSON to the agent invocation"
    - "First-time senders with no profile row pass SENDER_PROFILE = null to the agent"
    - "All sender profile writes (trigger flows step 11 and outcome tracker flow) use Dataverse Upsert with alternate key cr_senderemail_key instead of List+Condition+Add/Update"
    - "Flow 5 Branch A SENT_EDITED receives the pre-computed editDistanceRatio from the PCF payload instead of computing a 0/1 boolean in Power Automate"
    - "The deployment guide's input variable table lists SENDER_PROFILE as a formal named input variable"
    - "The Known Gap R-17 section is removed from agent-flows.md since the gap is now resolved"
  artifacts:
    - path: "enterprise-work-assistant/docs/agent-flows.md"
      provides: "Updated flow specs with Upsert pattern, sender profile passthrough, and pre-computed edit distance"
      contains: "Upsert"
    - path: "enterprise-work-assistant/docs/deployment-guide.md"
      provides: "Updated deployment guide confirming SENDER_PROFILE input variable is active"
      contains: "SENDER_PROFILE"
  key_links:
    - from: "enterprise-work-assistant/docs/agent-flows.md (Flow 1/2/3 trigger flows)"
      to: "enterprise-work-assistant/prompts/main-agent-system-prompt.md"
      via: "SENDER_PROFILE input variable passed to Execute Agent action"
      pattern: "SENDER_PROFILE"
    - from: "enterprise-work-assistant/docs/agent-flows.md (Flow 5 Branch A)"
      to: "enterprise-work-assistant/src/AssistantDashboard/index.ts"
      via: "editDistanceRatio from PCF JSON payload flows into outcome tracker"
      pattern: "editDistanceRatio"
---

<objective>
Update all Power Automate flow specifications to: (1) pass SENDER_PROFILE to the main agent via trigger flows, (2) migrate all sender profile writes from List+Condition+Add/Update to Dataverse Upsert with alternate key, and (3) update the outcome tracker to receive the pre-computed edit distance ratio from the PCF instead of computing a 0/1 boolean.

Purpose: Close the three remaining sender intelligence gaps — the agent needs sender data for adaptive triage (SNDR-01), concurrent writes need race-safe upsert (SNDR-02), and edit distance needs to be a real ratio not a boolean (SNDR-03 flow-side).

Output: Updated agent-flows.md and deployment-guide.md with all three fixes applied across Flows 1-3 and Flow 5.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sender-intelligence-completion/14-CONTEXT.md
@.planning/phases/14-sender-intelligence-completion/14-01-SUMMARY.md

@enterprise-work-assistant/docs/agent-flows.md
@enterprise-work-assistant/docs/deployment-guide.md
@enterprise-work-assistant/schemas/senderprofile-table.json
@enterprise-work-assistant/prompts/main-agent-system-prompt.md

<interfaces>
<!-- Key flow structures and data shapes the executor needs. -->

From senderprofile-table.json — the alternate key used for Upsert:
```json
{
  "alternateKeys": [
    {
      "schemaName": "cr_senderemail_key",
      "displayName": "Sender Email Key",
      "keyAttributes": ["cr_senderemail"]
    }
  ]
}
```

The 7 SENDER_PROFILE fields referenced in the agent prompt:
```json
{
  "signal_count": 47,
  "response_rate": 0.92,
  "avg_response_hours": 3.2,
  "dismiss_rate": 0.04,
  "avg_edit_distance": 32,
  "sender_category": "AUTO_HIGH",
  "is_internal": true
}
```

From 14-01-PLAN (PCF output change):
The PCF sendDraftAction JSON payload now includes `editDistanceRatio`:
```json
{ "cardId": "...", "finalText": "...", "editDistanceRatio": 42 }
```
The Canvas App receives this via ParseJSON and passes editDistanceRatio to the Card Outcome Tracker flow.

Current Flow 1 step 11 (Upsert pattern to replace — uses List+Condition+Add/Update):
- 11a. List rows — filter by cr_senderemail
- 11b. Condition — sender exists?
- 11c. If Yes: Update a row (increment signal count)
- 11d. If No: Add a new row (create profile)

Current Flow 5 edit distance (0/1 boolean to replace):
- 2a-1a. Compose EDIT_DISTANCE: simplified equals() check → 0 or 1
- 2a-1b. Compose NEW_AVG_EDIT_DISTANCE: running average with 0/1 value

Current Flow 5 Branch A step 4 (sender profile lookup to replace with Upsert):
- 4. List rows — Find sender profile by email + owner
- 5. Condition — sender profile exists?
- 6. Update a row — update response count, avg response hours, avg edit distance

Current Flow 5 Branch B (dismiss tracking to replace with Upsert):
- 2b-1. List rows — Find sender profile by email + owner
- 2b-2. Condition — sender profile exists?
- 2b-3. Update a row — increment dismiss count
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate trigger flows (1-3) to Upsert + add sender profile passthrough</name>
  <files>
    enterprise-work-assistant/docs/agent-flows.md
  </files>
  <action>
    This task modifies the Flow 1 (Email), Flow 2 (Teams), and Flow 3 (Calendar) sections of agent-flows.md. It makes two changes to each trigger flow: (1) replace the List+Condition+Add/Update sender upsert with Dataverse Upsert, and (2) add sender profile lookup + SENDER_PROFILE passthrough to the agent invocation.

    **Change 1: Replace step 11 (Upsert Sender Profile) in Flow 1 with Dataverse Upsert**

    Replace the current step 11 (11a List rows, 11b Condition, 11c Update, 11d Add new row) with a single Upsert action:

    ```markdown
    **11. Upsert Sender Profile** *(Sprint 1B — updated Phase 14: uses Dataverse Upsert with alternate key)*

    Uses the Dataverse connector's **"Update or add rows (V2)"** action (also known as Upsert) with the alternate key `cr_senderemail_key` to atomically create or update the sender profile. This eliminates the previous List+Condition+Add/Update pattern and prevents race conditions when multiple flows process signals from the same sender concurrently.

    | Setting | Value |
    |---------|-------|
    | Table name | Sender Profiles |
    | Alternate key | `cr_senderemail_key` |
    | cr_senderemail (key column) | `@{outputs('Compose_SENDER_EMAIL')}` |
    | Sender Display Name | `@{outputs('Compose_SENDER_DISPLAY')}` |
    | Signal Count | `@{add(coalesce(triggerOutputs()?['body/cr_signalcount'], 0), 1)}` |
    | Last Signal Date | `@{utcNow()}` |
    | Is Internal | See IS_INTERNAL Compose below |
    | **Owner** | `@{outputs('Get_my_profile_(V2)')?['body/id']}` |

    > **Note**: The Upsert action creates the row if no match exists for the alternate key, or updates the matching row. Fields not specified in the Upsert are left unchanged on update (so `cr_responsecount`, `cr_avgresponsehours`, `cr_dismisscount`, `cr_avgeditdistance` are not touched by trigger flows). For new rows, unspecified WholeNumber/Decimal fields default to null.

    > **Signal Count increment**: The `add(coalesce(..., 0), 1)` pattern handles both new rows (coalesce returns 0 when no existing row) and existing rows (reads current value). Note: if exact atomic increment is needed under high concurrency, consider using a Power Automate Cloud flow action with optimistic concurrency (ETag). For typical email/Teams volumes, the Upsert approach is sufficient.

    > **Sender Category**: Not set during upsert — new rows default to null (no category). The Sender Profile Analyzer (Flow 9) computes and sets `cr_sendercategory` weekly based on accumulated interaction data.
    ```

    Keep the IS_INTERNAL Compose action that follows step 11 unchanged.

    **Change 2: Add sender profile lookup + passthrough before agent invocation**

    In Flow 1, insert two new steps between step 3 (Compose USER_CONTEXT) and step 4 (Invoke the agent):

    ```markdown
    **3a. List sender profile** *(Phase 14: SENDER_PROFILE passthrough)*

    Look up the sender's profile to pass behavioral data to the agent for sender-adaptive triage.

    | Setting | Value |
    |---------|-------|
    | Table name | Sender Profiles |
    | Filter rows | `cr_senderemail eq '@{outputs('Compose_SENDER_EMAIL')}' and _ownerid_value eq '@{outputs('Get_my_profile_(V2)')?['body/id']}'` |
    | Row count | `1` |
    | Select columns | `cr_signalcount,cr_responserate,cr_avgresponsehours,cr_dismissrate,cr_avgeditdistance,cr_sendercategory,cr_isinternal` |

    **3b. Compose — SENDER_PROFILE** *(Phase 14)*

    Builds the 7-field JSON object the agent prompt expects, or null for first-time senders:

    ```
    @{if(
        greater(length(outputs('List_sender_profile')?['body/value']), 0),
        concat(
            '{"signal_count":',
            string(coalesce(first(outputs('List_sender_profile')?['body/value'])?['cr_signalcount'], 0)),
            ',"response_rate":',
            string(coalesce(first(outputs('List_sender_profile')?['body/value'])?['cr_responserate'], 0)),
            ',"avg_response_hours":',
            string(coalesce(first(outputs('List_sender_profile')?['body/value'])?['cr_avgresponsehours'], 0)),
            ',"dismiss_rate":',
            string(coalesce(first(outputs('List_sender_profile')?['body/value'])?['cr_dismissrate'], 0)),
            ',"avg_edit_distance":',
            string(coalesce(first(outputs('List_sender_profile')?['body/value'])?['cr_avgeditdistance'], 0)),
            ',"sender_category":"',
            coalesce(first(outputs('List_sender_profile')?['body/value'])?['cr_sendercategory'], 'null'),
            '","is_internal":',
            if(equals(first(outputs('List_sender_profile')?['body/value'])?['cr_isinternal'], true), 'true', 'false'),
            '}'
        ),
        'null'
    )}
    ```

    > **Note**: Uses `coalesce()` to handle null fields on partially-populated profiles. The `sender_category` field maps the Choice integer back to a label — if the Dataverse connector returns the label string, use it directly; if it returns the integer value, add a nested `if()` chain to map 100000000→"AUTO_HIGH", 100000001→"AUTO_MEDIUM", 100000002→"AUTO_LOW", 100000003→"USER_OVERRIDE".
    ```

    Then update the step 4 (Invoke the agent) input variable table to add SENDER_PROFILE:

    | Input Variable | Value |
    |---------------|-------|
    | TRIGGER_TYPE | `EMAIL` |
    | PAYLOAD | `@{outputs('Compose_PAYLOAD')}` |
    | USER_CONTEXT | `@{outputs('Compose_USER_CONTEXT')}` |
    | CURRENT_DATETIME | `@{utcNow()}` |
    | SENDER_PROFILE | `@{outputs('Compose_SENDER_PROFILE')}` |

    **Change 3: Apply same changes to Flow 2 (Teams) and Flow 3 (Calendar)**

    For Flow 2 (Teams):
    - Replace the "Sprint 1B: Sender upsert for TEAMS_MESSAGE flow" section with a reference to the same Upsert pattern as Flow 1 step 11, noting that the sender email is obtained via "Get user profile (V2)" action using the sender's AAD user ID
    - Add sender profile lookup (3a) and SENDER_PROFILE Compose (3b) before the agent invocation, same pattern as Flow 1 but using the Teams sender email

    For Flow 3 (Calendar):
    - Add Upsert step after the Dataverse card write inside the Apply to each loop, using the organizer's email address
    - Add sender profile lookup + SENDER_PROFILE passthrough before step 4c (Invoke agent), using organizer email as the sender identifier

    **Change 4: Remove the Known Gap R-17 section**

    Delete the "Known Gap: R-17 — SENDER_PROFILE Not Passed to Agent" section (lines ~1803-1811) since this gap is now resolved. Also remove the related checklist items:
    - Remove `- [ ] Note: R-17 (SENDER_PROFILE not passed to agent) is a known gap — sender-adaptive triage is inactive` from the Flow 9 deployment checklist
    - Remove `- [ ] Test: Sender profile passthrough (R-17) — deferred, verify agent works without it` from the same checklist
    - Add a positive checklist item: `- [ ] Trigger flows pass SENDER_PROFILE JSON (or null for first-time senders) to the main agent`

    **Change 5: Update the "Updating Existing Trigger Flows" section**

    The section at lines ~1782-1801 that described the sender profile passthrough as a future addition should be updated to reflect that it is now implemented. Change the heading and content to indicate these steps are now part of the standard flow specification (not a future update), referencing steps 3a and 3b in the trigger flows.
  </action>
  <verify>
    <automated>grep -c "Known Gap: R-17" enterprise-work-assistant/docs/agent-flows.md | xargs test 0 -eq && grep -c "Upsert" enterprise-work-assistant/docs/agent-flows.md | xargs test 0 -lt && grep -c "SENDER_PROFILE" enterprise-work-assistant/docs/agent-flows.md | xargs test 5 -lt && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - Flow 1 step 11 uses Dataverse Upsert with cr_senderemail_key (not List+Condition+Add/Update)
    - Flow 1 steps 3a-3b look up sender profile and compose SENDER_PROFILE JSON
    - Flow 1 step 4 passes SENDER_PROFILE as an input variable to the agent
    - Flow 2 and Flow 3 have equivalent Upsert + passthrough changes
    - Known Gap R-17 section is removed
    - All trigger flows handle first-time senders by passing null
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Flow 5 outcome tracker to use Upsert + pre-computed edit distance ratio</name>
  <files>
    enterprise-work-assistant/docs/agent-flows.md
    enterprise-work-assistant/docs/deployment-guide.md
  </files>
  <action>
    **Change 1: Update Flow 5 Branch A — SENT_EDITED edit distance**

    Replace the current step 2a-1a (Compose EDIT_DISTANCE) which computes a 0/1 boolean with a step that receives the pre-computed `editDistanceRatio` from the PCF payload:

    ```markdown
    **2a-1a. Compose — EDIT_DISTANCE** *(Phase 14: receives pre-computed ratio from PCF)*

    The edit distance ratio (0-100) is now computed client-side in the PCF component using a Levenshtein algorithm and passed through the Canvas App to this flow. The flow no longer computes edit distance — it receives it as an input parameter.

    ```
    @{triggerOutputs()?['body/cr_editdistanceratio']}
    ```

    > **Note**: The PCF component computes `editDistanceRatio` using Levenshtein distance when the user clicks Send. The Canvas App extracts `editDistanceRatio` from the PCF's `sendDraftAction` JSON output and writes it to the Assistant Card row alongside the outcome. If `editDistanceRatio` is null (legacy cards created before this change), fall back to the previous 0/1 approach:
    > ```
    > @{coalesce(
    >     triggerOutputs()?['body/cr_editdistanceratio'],
    >     if(equals(outputs('Get_the_modified_card_row')?['body/cr_cardoutcome'], 100000002), 100, 0)
    > )}
    > ```
    ```

    Keep step 2a-1b (Compose NEW_AVG_EDIT_DISTANCE) unchanged — the running average formula works identically whether the input is 0/1 or 0-100. The `cr_avgeditdistance` column is WholeNumber so it naturally stores the 0-100 integer.

    Remove the note about "A full Levenshtein distance is complex in Power Automate expressions" and the "simplified boolean comparison" explanation since the PCF now handles this.

    Update the note after step 2a-1b to reflect the new semantics:
    > The edit distance average is stored in `cr_avgeditdistance` on the SenderProfile table. Values range from 0 (user always sends drafts as-is) to 100 (user always completely rewrites drafts). The agent prompt's sender-adaptive confidence adjustment checks `avg_edit_distance > 70` to penalize confidence for senders whose drafts are frequently rewritten.

    **Change 2: Replace Flow 5 Branch A steps 4-6 (List+Condition+Update) with Upsert**

    Replace steps 4 (List rows - Find sender profile), 5 (Condition - Sender profile exists?), and 6 (Update a row) with a single Upsert action:

    ```markdown
    **4. Upsert sender profile — Response tracking** *(Phase 14: replaces List+Condition+Update)*

    Uses Dataverse Upsert with alternate key `cr_senderemail_key` to atomically update the sender's response metrics. This prevents race conditions when multiple cards from the same sender are actioned concurrently.

    | Setting | Value |
    |---------|-------|
    | Table name | Sender Profiles |
    | Alternate key | `cr_senderemail_key` |
    | cr_senderemail (key column) | `@{outputs('Get_the_modified_card_row')?['body/cr_originalsenderemail']}` |
    | Response Count | `@{add(coalesce(outputs('Get_the_modified_card_row')?['body/cr_responsecount_current'], 0), 1)}` |
    | Average Response Hours | `@{outputs('Compose_NEW_AVG_RESPONSE_HOURS')}` |
    | Average Edit Distance | `@{outputs('Compose_NEW_AVG_EDIT_DISTANCE')}` *(only for SENT_EDITED outcomes; omit field entirely for SENT_AS_IS)* |
    | **Owner** | `@{outputs('Get_the_modified_card_row')?['body/_ownerid_value']}` |

    > **Note**: The Upsert needs the current response count to compute the incremented value. Add a **"Get a row by ID"** action before this Upsert to fetch the current sender profile by alternate key: Table = Sender Profiles, Alternate Key = `cr_senderemail_key`, Key Value = the sender email. Select columns: `cr_responsecount,cr_avgresponsehours,cr_avgeditdistance`. If no row exists (404), the Upsert creates it with the provided values.

    > **Design note**: Upsert writes only outcome-specific fields per user decision. SENT_AS_IS updates response count + avg response hours. SENT_EDITED also updates avg edit distance. Fields not specified in the Upsert are left unchanged.
    ```

    **Change 3: Replace Flow 5 Branch B (DISMISSED) with Upsert**

    Replace steps 2b-1 (List rows), 2b-2 (Condition), and 2b-3 (Update a row) with a single Upsert:

    ```markdown
    **Branch B: DISMISSED — Increment dismiss count** *(Phase 14: uses Upsert)*

    When a user dismisses a card, the sender's dismiss count is incremented via Upsert. This data feeds the Sender Profile Analyzer (Flow 9) for AUTO_LOW categorization.

    **2b-1. Get sender profile by alternate key** — Dataverse → Sender Profiles

    | Setting | Value |
    |---------|-------|
    | Table name | Sender Profiles |
    | Alternate key | `cr_senderemail_key` |
    | Key value | `@{outputs('Get_the_modified_card_row')?['body/cr_originalsenderemail']}` |
    | Select columns | `cr_dismisscount` |

    Configure a **Run after** setting to run on both success and failure (404 = no existing profile).

    **2b-2. Upsert sender profile — Dismiss tracking**

    | Setting | Value |
    |---------|-------|
    | Table name | Sender Profiles |
    | Alternate key | `cr_senderemail_key` |
    | cr_senderemail (key column) | `@{outputs('Get_the_modified_card_row')?['body/cr_originalsenderemail']}` |
    | Dismiss Count | `@{add(coalesce(outputs('Get_sender_profile_dismissed')?['body/cr_dismisscount'], 0), 1)}` |
    | **Owner** | `@{outputs('Get_the_modified_card_row')?['body/_ownerid_value']}` |

    > Do NOT update response hours or response count for dismissals. Only `cr_dismisscount` is incremented.
    > The `coalesce(..., 0)` handles the case where no sender profile exists yet (first interaction was a dismiss without a prior signal — unlikely but possible if the trigger flow's upsert failed).
    ```

    **Change 4: Update Flow 5 flow diagram**

    Update the flow diagram to reflect the Upsert pattern:

    ```
    Trigger (cr_cardoutcome changed, non-PENDING)
      |
      +-- 1. Get modified card row
      +-- 2. Switch on outcome type:
          |
          +-- Branch A: SENT_AS_IS or SENT_EDITED
          |   +-- 2a-1. Is SENT_EDITED?
          |   |   +-- Yes: Read pre-computed edit distance ratio + compute running avg
          |   +-- 3. Calculate response hours
          |   +-- 4. Upsert sender profile (response count, avg hours, avg edit distance)
          |
          +-- Branch B: DISMISSED
          |   +-- 2b-1. Get current dismiss count (alternate key, run-after success+failure)
          |   +-- 2b-2. Upsert sender profile (dismiss count)
          |
          +-- Branch C: EXPIRED -> Terminate
    ```

    **Change 5: Update deployment-guide.md**

    In Section 2.3 "Set Up Input Variables":
    - The table already lists SENDER_PROFILE as "Optional (Sprint 4)" — update the description to clarify it is now actively populated by the trigger flows:
      - Change "Optional (Sprint 4)" to "Optional"
      - Update the description: "Serialized sender profile JSON from SenderProfile table, or the string 'null' for first-time senders. Contains signal_count, response_rate, avg_response_hours, dismiss_rate, avg_edit_distance, sender_category, is_internal. Populated by trigger flows (Flows 1-3) before agent invocation. Enables sender-adaptive triage threshold adjustments."

    In Section 6 "Sprint 4: Sender Intelligence", update the checklist item:
    - Change `- [ ] Trigger flows pass SENDER_PROFILE JSON to the main agent` to `- [x] Trigger flows pass SENDER_PROFILE JSON to the main agent` (mark as done)

    **Change 6: Document the cr_editdistanceratio column requirement**

    Add a note near the top of Flow 5 or in the Assistant Cards table schema reference noting that a new column `cr_editdistanceratio` (WholeNumber, 0-100, nullable) should be added to the Assistant Cards table to store the per-card edit distance ratio. The Canvas App writes this value when processing the PCF's sendDraftAction output. This column is read by the Card Outcome Tracker flow to compute the sender-level running average.

    Alternatively, if the edit distance ratio should flow through a different mechanism (e.g., as a parameter to the Card Outcome Tracker flow invocation rather than a Dataverse column), document that approach instead. The key requirement is that Flow 5 can access the PCF-computed editDistanceRatio value.
  </action>
  <verify>
    <automated>grep -c "List+Condition+Add/Update\|List → Condition → Add/Update" enterprise-work-assistant/docs/agent-flows.md | xargs test 0 -eq && grep -c "alternate key" enterprise-work-assistant/docs/agent-flows.md | xargs test 2 -lt && grep -c "editDistanceRatio\|edit distance ratio" enterprise-work-assistant/docs/agent-flows.md | xargs test 0 -lt && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - Flow 5 Branch A uses pre-computed editDistanceRatio from PCF (not 0/1 boolean)
    - Flow 5 Branch A step 4 uses Upsert with cr_senderemail_key (not List+Condition+Update)
    - Flow 5 Branch B uses Upsert with cr_senderemail_key (not List+Condition+Update)
    - Flow 5 flow diagram updated to show Upsert pattern
    - deployment-guide.md SENDER_PROFILE description updated to reflect active population
    - cr_editdistanceratio column or flow parameter documented for passing PCF-computed ratio to Flow 5
  </done>
</task>

</tasks>

<verification>
1. `grep -c "Known Gap: R-17" enterprise-work-assistant/docs/agent-flows.md` returns 0 — gap is resolved and removed
2. `grep -c "Upsert" enterprise-work-assistant/docs/agent-flows.md` returns 4+ — upsert used in Flows 1, 2, 3, and 5
3. `grep -c "SENDER_PROFILE" enterprise-work-assistant/docs/agent-flows.md` returns 10+ — passthrough documented in all trigger flows
4. `grep "cr_senderemail_key" enterprise-work-assistant/docs/agent-flows.md` returns matches — alternate key referenced in upsert actions
5. `grep "editDistanceRatio" enterprise-work-assistant/docs/agent-flows.md` returns match — pre-computed ratio referenced in Flow 5
6. `grep "Optional (Sprint 4)" enterprise-work-assistant/docs/deployment-guide.md` returns 0 — Sprint 4 qualifier removed from SENDER_PROFILE
7. No instances of "List rows — Find sender profile" pattern remain in Flows 1-3 step 11 (replaced by Upsert)
</verification>

<success_criteria>
- All sender profile writes across all flows use Dataverse Upsert with alternate key cr_senderemail_key
- Trigger flows 1-3 pass SENDER_PROFILE JSON (7 fields or null) to the main agent
- Flow 5 uses pre-computed edit distance ratio from PCF, not the simplified 0/1 boolean
- Known Gap R-17 removed — sender-adaptive triage is now active
- Deployment guide reflects SENDER_PROFILE as actively populated
</success_criteria>

<output>
After completion, create `.planning/phases/14-sender-intelligence-completion/14-02-SUMMARY.md`
</output>
