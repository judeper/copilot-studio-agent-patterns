---
phase: 07-documentation-accuracy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - enterprise-work-assistant/docs/agent-flows.md
autonomous: true
requirements:
  - DOC-02
  - DOC-03

must_haves:
  truths:
    - "Agent-flows.md directs developers to use the Microsoft Copilot Studio connector's Execute Agent and wait action, not the AI Builder Run a prompt action"
    - "Agent-flows.md includes directly copy-pasteable PA expression examples for all five Choice columns using real field names"
    - "Agent-flows.md PA simplified schema declares item_summary as non-nullable string (type: string, not type: [string, null])"
    - "Agent-flows.md prerequisites mention research tool action registration with a cross-reference link to deployment-guide.md"
    - "All connector action references throughout the file are updated consistently (step 4 in all three flows, step 9 humanizer invocation)"
  artifacts:
    - path: "enterprise-work-assistant/docs/agent-flows.md"
      provides: "Corrected agent flows guide with accurate connector actions, complete expression examples, and fixed schema"
      contains: "Execute Agent and wait"
  key_links:
    - from: "enterprise-work-assistant/docs/agent-flows.md"
      to: "enterprise-work-assistant/docs/deployment-guide.md"
      via: "Cross-reference link for research tool registration"
      pattern: "deployment-guide\\.md.*Section 2\\.4"
    - from: "enterprise-work-assistant/docs/agent-flows.md"
      to: "schemas/output-schema.json"
      via: "Schema contract reference for nullability"
      pattern: "output-schema\\.json"
---

<objective>
Fix agent-flows.md: replace "Run a prompt" with "Execute Agent and wait" throughout (DOC-03), add complete copy-pasteable PA expression examples for all Choice columns plus null handling and JSON parsing (DOC-02), fix item_summary nullability in PA simplified schema (audit addition), add research tool prerequisite cross-reference to deployment guide (DOC-04), and add Last verified dates.

Purpose: A developer building Power Automate flows must use the correct Copilot Studio connector action and have ready-to-use expressions for all Choice column mappings.
Output: Updated `enterprise-work-assistant/docs/agent-flows.md`
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-documentation-accuracy/07-RESEARCH.md
@enterprise-work-assistant/docs/agent-flows.md
@enterprise-work-assistant/schemas/output-schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix connector action name and add expression examples</name>
  <files>enterprise-work-assistant/docs/agent-flows.md</files>
  <action>
Make five changes to agent-flows.md:

**Change 1 — Fix connector action throughout (DOC-03):**

Replace ALL references to "Run a prompt" and "Invoke a Copilot Agent" with the correct action name. This is a CRITICAL fix — using the wrong action would prevent the flows from working entirely.

Specific locations to fix:

a) **Flow 1, step 4** (line ~145): Replace the entire step 4 paragraph. Current text says:
   > Add the **Copilot Studio** connector (search for "Copilot" in the connector list). Select the **"Run a prompt"** action (in some environments this appears as **"Invoke a Copilot Agent"** — the exact label may vary by platform version). Choose the **Enterprise Work Assistant** agent.

   Replace with:
   > Add the **Microsoft Copilot Studio** connector (search for "Microsoft Copilot Studio" in the connector list — do NOT use the AI Builder connector). Select the **"Execute Agent and wait"** action. Choose the **Enterprise Work Assistant** agent.
   >
   > **Important**: "Run a prompt" is a different action (AI Builder) that runs a standalone prompt, not a full agent. You must use **"Execute Agent and wait"** from the **Microsoft Copilot Studio** connector to invoke an agent with its system prompt, tools, and orchestration.

b) Update the note below step 4 about the dynamic content picker. Replace the current note:
   > After adding the action, check the *dynamic content picker* to confirm the correct output field name for the agent's response. It is typically `text` or `responsemessage` depending on the connector version. Use this field name consistently in steps 5 and 7.

   With:
   > After adding the action, check the *dynamic content picker* for the agent's response. The Execute Agent and wait action returns a `lastResponse` field (the agent's final text response). Use this field name consistently in steps 5 and 7. If the field name differs in your environment, verify via the dynamic content picker.

c) **Flow 1, step 7** — Full JSON Output column value (line ~195): Replace `@{body('Invoke_agent')?['text']}` with `@{body('Execute_Agent_and_wait')?['lastResponse']}`. Keep the "verify field name" note.

d) **Flow 1, step 9** (line ~216): Replace "Add another Copilot Studio "Run a prompt" action" with "Add another **Microsoft Copilot Studio** **"Execute Agent and wait"** action".

e) **Flow 2, step 2-10 reference** (line ~273): The reference says "Same pattern as Flow 1" — this is fine as-is since it inherits the corrected Flow 1 instructions. No change needed.

f) **Section 2.5 in deployment-guide.md cross-reference** — the deployment guide mentions "Invoke agent" action in its publish note (line ~152). Do NOT change deployment-guide.md in this plan (owned by Plan 01). But verify agent-flows.md does not use the term "Invoke agent" — if found, replace with "Execute Agent and wait".

g) Add a brief connector distinction note near the top of the file (after Prerequisites, before the Row Ownership section):
   > **Connector Note**: These flows use the **Microsoft Copilot Studio** connector's **"Execute Agent and wait"** action to invoke agents. Do not confuse this with the AI Builder **"Run a prompt"** action, which runs standalone prompts (not full agents). *Last verified: Feb 2026*

**Change 2 — Add complete Choice column expression examples (DOC-02):**

Replace the current step 7's single trigger_type example and the "Repeat this pattern..." instruction (lines ~170-184) with the complete set of copy-pasteable expressions.

After the intro text about Choice columns needing integer mapping, add a subsection with all five expressions. Use Compose action naming convention for clarity:

```
**Compose — Triage Tier Value:**
if(equals(body('Parse_JSON')?['triage_tier'],'SKIP'),100000000,if(equals(body('Parse_JSON')?['triage_tier'],'LIGHT'),100000001,100000002))

**Compose — Trigger Type Value:**
if(equals(body('Parse_JSON')?['trigger_type'],'EMAIL'),100000000,if(equals(body('Parse_JSON')?['trigger_type'],'TEAMS_MESSAGE'),100000001,100000002))

**Compose — Priority Value:**
if(equals(body('Parse_JSON')?['priority'],'High'),100000000,if(equals(body('Parse_JSON')?['priority'],'Medium'),100000001,if(equals(body('Parse_JSON')?['priority'],'Low'),100000002,100000003)))

**Compose — Card Status Value:**
if(equals(body('Parse_JSON')?['card_status'],'READY'),100000000,if(equals(body('Parse_JSON')?['card_status'],'LOW_CONFIDENCE'),100000001,if(equals(body('Parse_JSON')?['card_status'],'SUMMARY_ONLY'),100000002,100000003)))

**Compose — Temporal Horizon Value:**
if(equals(body('Parse_JSON')?['temporal_horizon'],'TODAY'),100000000,if(equals(body('Parse_JSON')?['temporal_horizon'],'THIS_WEEK'),100000001,if(equals(body('Parse_JSON')?['temporal_horizon'],'NEXT_WEEK'),100000002,if(equals(body('Parse_JSON')?['temporal_horizon'],'BEYOND'),100000003,100000004))))
```

Each expression in its own code block with a bold label. Keep the column mapping table at the end of the document as a reference, but add a note: "See step 7 above for copy-pasteable expressions."

Also add two additional expression patterns after the five Choice column examples:

**Null handling for optional integer columns:**
```
@{if(equals(body('Parse_JSON')?['confidence_score'], null), 0, body('Parse_JSON')?['confidence_score'])}
```
Brief explanation: "Use when writing confidence_score to Dataverse — coalesces null to 0 for SKIP/LIGHT tier items."

**JSON serialization for draft_payload:**
```
@{string(body('Parse_JSON')?['draft_payload'])}
```
Brief explanation: "Serializes the draft_payload object back to a JSON string. Used when passing to the Humanizer Agent (step 9) and when storing the Full JSON Output."

**Change 3 — Fix item_summary nullability in PA simplified schema (audit addition):**

In the "Parse JSON Schema" section (line ~39), change:
```json
"item_summary": { "type": ["string", "null"] },
```
to:
```json
"item_summary": { "type": "string" },
```

This aligns with Phase 1's established contract that item_summary is always a non-nullable string — the agent always generates a summary, even for SKIP-tier items.

Add a note after the schema: "The `item_summary` field is always a non-nullable string. Even SKIP-tier items include a brief summary (e.g., 'Marketing newsletter from Contoso Weekly — no action needed.'). See `schemas/output-schema.json` for the canonical contract."

**Change 4 — Add research tool prerequisite cross-reference (DOC-04):**

In the Prerequisites section at the top of the file (lines ~7-9), add a bullet:
- Research tool actions registered in Copilot Studio (see [deployment-guide.md](deployment-guide.md), Section 2.4)

**Change 5 — Add Last verified dates:**

Add "*Last verified: Feb 2026*" to:
- The Connector Note added in Change 1
- After the PA simplified schema section
- After the Choice Value Mapping table at the end
  </action>
  <verify>
Read the modified agent-flows.md and confirm:
1. Search for "Run a prompt" — should appear ONLY in the connector distinction note explaining it is a DIFFERENT action (not as an instruction to use it)
2. Search for "Execute Agent and wait" — should appear in step 4, step 9, and the connector note
3. Search for "lastResponse" — should appear in the dynamic content note and the Full JSON Output column value
4. Search for `body('Invoke_agent')` — should NOT appear anywhere (replaced with `body('Execute_Agent_and_wait')`)
5. Count occurrences of "Compose —" followed by a Choice column name — should find 5 (Triage Tier, Trigger Type, Priority, Card Status, Temporal Horizon)
6. Search for `"item_summary": { "type": "string" }` — should find exactly 1 (non-nullable)
7. Search for `"item_summary": { "type": ["string", "null"] }` — should find 0
8. Search for "deployment-guide.md.*Section 2.4" — should find at least 1 cross-reference
9. Search for "Last verified" — should find at least 3 occurrences
10. Verify "Repeat this pattern" instruction for Choice columns is removed (replaced by explicit examples)
  </verify>
  <done>
Agent-flows.md uses "Execute Agent and wait" consistently, includes copy-pasteable expressions for all five Choice columns plus null handling and JSON serialization patterns, PA simplified schema declares item_summary as non-nullable string, and prerequisites include research tool cross-reference to deployment guide.
  </done>
</task>

</tasks>

<verification>
- Grep for "Run a prompt" — should only appear in the distinction/warning context, never as an instruction
- Grep for "Execute Agent and wait" — should appear as the primary action in all flow steps
- Grep for `["string", "null"]` in the schema block — item_summary must NOT have this pattern
- Grep for "Repeat this pattern" — should NOT appear (replaced by explicit expressions)
- Grep for "deployment-guide.md" — should find cross-reference link
- Count Choice column expressions — must be exactly 5 complete if() chains
</verification>

<success_criteria>
- DOC-02: All five Choice columns have directly copy-pasteable expression examples with real field names
- DOC-03: All connector action references use "Execute Agent and wait" from "Microsoft Copilot Studio" connector
- DOC-04: Research tool registration cross-referenced to deployment guide Section 2.4
- Audit: item_summary is non-nullable string in PA simplified schema
</success_criteria>

<output>
After completion, create `.planning/phases/07-documentation-accuracy/07-02-SUMMARY.md`
</output>
