---
phase: 06-powershell-script-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - enterprise-work-assistant/scripts/deploy-solution.ps1
  - enterprise-work-assistant/scripts/create-security-roles.ps1
  - enterprise-work-assistant/docs/deployment-guide.md
autonomous: true
requirements:
  - DOC-05
  - DOC-06

must_haves:
  truths:
    - "deploy-solution.ps1 uses bun install and bun run build (not npm) and checks for Bun in prerequisites"
    - "deploy-solution.ps1 trusts pac solution import exit code instead of polling with pac solution list"
    - "deploy-solution.ps1 supports -WhatIf flag that shows planned operations without executing"
    - "deploy-solution.ps1 exits with structured codes: 0=success, 1=prereq, 2=build, 3=import"
    - "deploy-solution.ps1 writes a timestamped deploy log via Start-Transcript"
    - "create-security-roles.ps1 throws on missing privilege instead of warning and continuing"
    - "create-security-roles.ps1 checks Azure CLI installed and authenticated before proceeding"
    - "deployment-guide.md Phase 5 manual build commands use bun (not npm)"
  artifacts:
    - path: "enterprise-work-assistant/scripts/deploy-solution.ps1"
      provides: "Production-quality deploy script with WhatIf, logging, prereq checks, structured exit codes, Bun commands"
      contains: "SupportsShouldProcess"
    - path: "enterprise-work-assistant/scripts/create-security-roles.ps1"
      provides: "Hardened security role script with fail-fast on missing privilege and Azure CLI prereq check"
      contains: "throw.*Privilege"
    - path: "enterprise-work-assistant/docs/deployment-guide.md"
      provides: "Deployment guide with correct Bun build commands"
      contains: "bun install"
  key_links:
    - from: "enterprise-work-assistant/scripts/deploy-solution.ps1"
      to: "bun install / bun run build"
      via: "Replaced npm commands with Bun equivalents from Phase 3 migration"
      pattern: "bun (install|run build)"
    - from: "enterprise-work-assistant/scripts/deploy-solution.ps1"
      to: "pac solution import exit code"
      via: "Removed pac solution list verification, trust LASTEXITCODE from pac solution import"
      pattern: "LASTEXITCODE.*exit 3"
    - from: "enterprise-work-assistant/docs/deployment-guide.md"
      to: "enterprise-work-assistant/scripts/deploy-solution.ps1"
      via: "Manual build commands match script's Bun commands"
      pattern: "bun install"
---

<objective>
Fix deploy-solution.ps1 and create-security-roles.ps1 to work correctly: align build commands with Bun (Phase 3 migration), remove broken import verification polling, add WhatIf support, structured exit codes, logging, and prerequisite checks. Update deployment guide manual build commands from npm to bun.

Purpose: Deployment scripts must actually work when run. Currently deploy-solution.ps1 uses npm (project migrated to Bun in Phase 3), has a misleading verification step that checks solution existence instead of import success, lacks WhatIf/logging/structured exit codes, and has incomplete prerequisite checks. create-security-roles.ps1 silently continues when privileges are not found.

Output: Three fixed files -- two production-quality PowerShell scripts and an updated deployment guide.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-powershell-script-fixes/06-RESEARCH.md

# Phase 3 summary -- confirms Bun migration details (bun.lock, bun 1.3.8)
@.planning/phases/03-pcf-build-configuration/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Overhaul deploy-solution.ps1 with WhatIf, Bun, logging, prereqs, and structured exit codes</name>
  <files>enterprise-work-assistant/scripts/deploy-solution.ps1</files>
  <action>
Rewrite deploy-solution.ps1 applying all locked decisions. The script structure stays the same (6 sections) but every section gets improvements. Use the research code examples as direct reference.

**Help block:** Replace the existing help block with an expanded version that documents:
- Updated .DESCRIPTION mentioning Bun, prerequisite validation, WhatIf support, and logging
- All parameters including the implicit -WhatIf
- Exit codes: 0=success, 1=prerequisite failure, 2=build failure, 3=import failure
- Two .EXAMPLE blocks (normal run and WhatIf run)

**CmdletBinding:** Add `[CmdletBinding(SupportsShouldProcess)]` immediately before the existing `param()` block. Keep all existing parameters unchanged.

**Logging:** After the param block and `$ErrorActionPreference = "Stop"`, add Start-Transcript:
```powershell
$logFile = Join-Path $PSScriptRoot "deploy-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
Start-Transcript -Path $logFile -UseMinimalHeader
```
Wrap the ENTIRE rest of the script body in `try { ... } finally { Stop-Transcript }`. All `exit` calls must be inside the `try` block so `finally` runs.

**Section 1 - Prerequisites:** Replace the current Node.js + PAC checks with a comprehensive block using `Get-Command -ErrorAction SilentlyContinue`:
- Check Bun (install hint: `https://bun.sh`)
- Check Node.js (install hint: `https://nodejs.org`)
- Check .NET SDK (install hint: `https://dotnet.microsoft.com/download`)
- Check PAC CLI (install hint: `dotnet tool install --global Microsoft.PowerApps.CLI.Tool`)
- Check PAC auth (only if pac exists): `pac auth list`, check for "No profiles" or non-zero exit
- Track `$prereqFailed` boolean, `exit 1` if any missing
- Display version (best effort, `2>&1`) for each found tool in Green, MISSING in Red with install hint in Yellow
- Keep the existing `Resolve-Path $SolutionPath` line after prereqs (it is non-destructive, runs even in WhatIf)
- Use existence-only checks, not minimum version enforcement (per Claude's Discretion decision in research)

**Section 2 - Install Dependencies:** Replace npm with bun, wrap in ShouldProcess:
```powershell
if ($PSCmdlet.ShouldProcess($SolutionPath, "Install dependencies (bun install)")) {
    Write-Host "Installing dependencies..." -ForegroundColor Cyan
    Push-Location $SolutionPath
    try {
        bun install
        if ($LASTEXITCODE -ne 0) {
            Write-Host "bun install failed." -ForegroundColor Red
            exit 2
        }
        Write-Host "  Dependencies installed." -ForegroundColor Green
    } finally {
        Pop-Location
    }
}
```

**Section 3 - Build PCF Component:** Replace npm with bun, wrap in ShouldProcess:
```powershell
if ($PSCmdlet.ShouldProcess($SolutionPath, "Build PCF component (bun run build)")) {
    Write-Host "Building PCF component..." -ForegroundColor Cyan
    Push-Location $SolutionPath
    try {
        bun run build
        if ($LASTEXITCODE -ne 0) {
            Write-Host "PCF build failed. Check TypeScript errors above." -ForegroundColor Red
            exit 2
        }
        Write-Host "  Build successful." -ForegroundColor Green
    } finally {
        Pop-Location
    }
}
```

**Section 4 - Pack Solution:** Wrap `dotnet build` and zip copy in ShouldProcess. Keep the Remove-Item for old zip inside ShouldProcess. Use `exit 2` (build failure) for dotnet build or missing zip errors.

**Section 5 - Import Solution:** Wrap the `pac solution import` call in ShouldProcess. Replace the current `throw` with improved error messaging:
```powershell
if ($PSCmdlet.ShouldProcess("Environment $EnvironmentId", "Import solution ($SolutionName)")) {
    Write-Host "Importing solution to environment $EnvironmentId..." -ForegroundColor Cyan
    Write-Host "  This may take several minutes..." -ForegroundColor Yellow
    pac solution import --path $zipPath --environment $EnvironmentId
    if ($LASTEXITCODE -ne 0) {
        Write-Host "Solution import failed (exit code: $LASTEXITCODE)." -ForegroundColor Red
        Write-Host "Check the PAC CLI output above for details." -ForegroundColor Yellow
        Write-Host "Common causes: missing dependencies, version conflict, auth expired." -ForegroundColor Yellow
        exit 3
    }
    Write-Host "  Solution imported and verified (exit code 0)." -ForegroundColor Green
}
```

**Section 6 - Remove broken verification, keep summary:** DELETE the `pac solution list --environment $EnvironmentId` call and its "Verifying deployment..." header entirely (this is DOC-05 -- the verification checked existence, not import result). Keep the DEPLOYMENT COMPLETE banner and NEXT STEPS output.

**Critical checks:**
- Every `exit N` call is inside the `try` block (the `finally { Stop-Transcript }` must always execute)
- Check `$LASTEXITCODE` immediately after each native command (bun install, bun run build, dotnet build, pac solution import) with no PowerShell cmdlets between
- Non-destructive operations (prerequisite checks, path resolution, summary output) run even in WhatIf mode
- The backtick line continuation on `pac solution import` is preserved or reformatted to a single line
  </action>
  <verify>
1. PowerShell syntax check: `pwsh -Command "& { Get-Command -Syntax (Resolve-Path 'enterprise-work-assistant/scripts/deploy-solution.ps1') }" 2>&1` should not error
2. Grep for `npm` in the script -- must return zero matches
3. Grep for `SupportsShouldProcess` -- must return one match
4. Grep for `Start-Transcript` -- must return one match
5. Grep for `exit 1`, `exit 2`, `exit 3` -- must each return at least one match
6. Grep for `pac solution list` -- must return zero matches (broken verification removed)
7. Grep for `bun install` and `bun run build` -- must each return at least one match
  </verify>
  <done>
deploy-solution.ps1 uses Bun for build commands, has SupportsShouldProcess for WhatIf, checks five prerequisites (Bun, Node.js, dotnet, pac, pac auth), logs via Start-Transcript, uses structured exit codes (0/1/2/3), trusts pac solution import exit code (no pac solution list polling), and has a complete help block documenting all of this.
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden create-security-roles.ps1 error handling and update deployment guide Bun commands</name>
  <files>
enterprise-work-assistant/scripts/create-security-roles.ps1
enterprise-work-assistant/docs/deployment-guide.md
  </files>
  <action>
Two small targeted fixes in separate files.

**create-security-roles.ps1 changes:**

1. **Add Azure CLI prerequisite check** (insert after `$ErrorActionPreference = "Stop"`, before Section 1 "Get Access Token"):

Add a new section "0. Validate Prerequisites" before the existing Section 1:
```powershell
# -----------------------------------------
# 0. Validate Prerequisites
# -----------------------------------------
Write-Host "Validating prerequisites..." -ForegroundColor Cyan

if (-not (Get-Command az -ErrorAction SilentlyContinue)) {
    throw "Azure CLI (az) is not installed. Install from https://aka.ms/installazurecli"
}
$azVer = az version --query '"azure-cli"' -o tsv 2>&1
Write-Host "  Azure CLI: $azVer" -ForegroundColor Green

$azAccount = az account show 2>&1
if ($LASTEXITCODE -ne 0) {
    throw "Azure CLI is not authenticated. Run 'az login --tenant <tenant-id>' first."
}
Write-Host "  Azure CLI auth: OK" -ForegroundColor Green
```

2. **Change privilege-not-found from warning to throw** (Section 4, lines 118-119):
Replace:
```powershell
        } else {
            Write-Warning "  Privilege '$privName' not found. Table may not be published yet."
        }
```
With:
```powershell
        } else {
            throw "Privilege '$privName' not found. The ${PublisherPrefix}_assistantcard table may not be published yet. Import the solution first, then re-run this script."
        }
```

3. **Change outer catch from warning to throw** (Section 4, lines 121-123):
Replace:
```powershell
    } catch {
        Write-Warning "  Failed to assign '$privName': $($_.Exception.Message)"
    }
```
With:
```powershell
    } catch {
        throw "Failed to assign privilege '$privName': $($_.Exception.Message)"
    }
```

**deployment-guide.md change:**

In Phase 5 section (around line 207-209), change the manual build commands from npm to bun:
Replace:
```
npm install
npm run build
```
With:
```
bun install
bun run build
```

Also in the Prerequisites section (around line 9), add Bun to the prerequisite list:
- After the `Node.js 18+` line, add: `- [ ] **Bun** installed (`curl -fsSL https://bun.sh/install | bash` or see https://bun.sh)`
  </action>
  <verify>
1. Grep create-security-roles.ps1 for `Write-Warning` -- must return zero matches (all converted to throw)
2. Grep create-security-roles.ps1 for `Get-Command az` -- must return one match (prereq check added)
3. Grep create-security-roles.ps1 for `throw.*Privilege` -- must return at least one match
4. Grep deployment-guide.md for `npm install` -- must return zero matches
5. Grep deployment-guide.md for `bun install` -- must return at least one match
6. Grep deployment-guide.md for `Bun` in prerequisites section -- must return at least one match
  </verify>
  <done>
create-security-roles.ps1 fails fast (throws) when any privilege is not found or any privilege assignment fails, and validates Azure CLI presence and authentication before proceeding. deployment-guide.md Phase 5 manual commands use bun install/bun run build and prerequisites list Bun as a requirement.
  </done>
</task>

</tasks>

<verification>
1. **deploy-solution.ps1**: No `npm` references, has `SupportsShouldProcess`, has `Start-Transcript`, has exit codes 1/2/3, no `pac solution list`, has Bun prereq check
2. **create-security-roles.ps1**: No `Write-Warning`, has Azure CLI prereq check, throws on missing privilege
3. **deployment-guide.md**: No `npm install`/`npm run build`, has `bun install`/`bun run build`, has Bun in prerequisites
4. All three files are syntactically valid (PowerShell parse check for .ps1 files)
</verification>

<success_criteria>
- deploy-solution.ps1 is a reference-quality deployment script with WhatIf, logging, prereqs, structured exit codes, and Bun build commands
- create-security-roles.ps1 fails fast on any privilege issue and validates Azure CLI upfront
- deployment-guide.md manual build commands match the Bun migration from Phase 3
- DOC-05 satisfied: pac solution list polling removed, exit code trusted
- DOC-06 satisfied: PublisherPrefix parameter already exists (confirmed), error handling hardened
</success_criteria>

<output>
After completion, create `.planning/phases/06-powershell-script-fixes/06-01-SUMMARY.md`
</output>
