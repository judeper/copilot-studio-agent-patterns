---
phase: 05-pcf-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - enterprise-work-assistant/src/AssistantDashboard/utils/urlSanitizer.ts
  - enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx
autonomous: true
requirements:
  - PCF-04

must_haves:
  truths:
    - "URLs with javascript:, data:, or vbscript: schemes are never rendered as clickable links"
    - "URLs with https: or mailto: schemes render as clickable Link elements"
    - "Unsafe URLs are visible as plain text (not silently stripped, not href='#')"
    - "bun run build completes with zero errors and zero warnings"
  artifacts:
    - path: "enterprise-work-assistant/src/AssistantDashboard/utils/urlSanitizer.ts"
      provides: "URL validation utility with protocol allowlist"
      exports: ["isSafeUrl", "SAFE_PROTOCOLS"]
      min_lines: 15
    - path: "enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx"
      provides: "Conditional Link vs Text rendering for verified_sources URLs"
      contains: "isSafeUrl"
  key_links:
    - from: "enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx"
      to: "enterprise-work-assistant/src/AssistantDashboard/utils/urlSanitizer.ts"
      via: "import { isSafeUrl }"
      pattern: "import.*isSafeUrl.*urlSanitizer"
    - from: "enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx"
      to: "isSafeUrl(source.url)"
      via: "conditional rendering of Link vs Text"
      pattern: "isSafeUrl\\(source\\.url\\).*Link|Text"
---

<objective>
Create a URL sanitization utility and integrate it into CardDetail.tsx to prevent XSS attacks through external URLs rendered as clickable links.

Purpose: The PCF control renders `verified_sources[].url` as clickable `<Link>` elements. The current regex guard (`/^https?:\/\//`) is case-sensitive, misses obfuscation techniques, and falls back to `href="#"` (still an active link). This plan replaces it with a browser-native URL constructor allowlist and conditional Link vs Text rendering per OWASP best practices.

Output: A zero-dependency URL validation utility (`isSafeUrl`) and a hardened CardDetail.tsx that renders safe URLs as links and unsafe URLs as plain text.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pcf-security-hardening/05-RESEARCH.md
@enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create URL sanitization utility</name>
  <files>enterprise-work-assistant/src/AssistantDashboard/utils/urlSanitizer.ts</files>
  <action>
Create a new file `enterprise-work-assistant/src/AssistantDashboard/utils/urlSanitizer.ts` with:

1. A `SAFE_PROTOCOLS` constant: `ReadonlySet<string>` containing `"https:"` and `"mailto:"` only. Export it (useful for testing and future extension).

2. An `isSafeUrl()` function with this exact signature and behavior:
```typescript
export function isSafeUrl(url: string | null | undefined): boolean
```
- Return `false` for null, undefined, or non-string inputs
- Trim the input string before parsing
- Use `new URL(url.trim())` to parse (browser-native WHATWG URL constructor)
- Check `parsed.protocol.toLowerCase()` against `SAFE_PROTOCOLS` using `.has()`
- Wrap in try/catch -- the URL constructor throws TypeError for malformed/relative URLs; catch returns `false`

Include JSDoc comments on both exports explaining:
- The allowlist policy (https and mailto only; enterprise schemes deferred)
- What the URL constructor handles (case normalization, whitespace stripping, control character removal)
- What returns false (dangerous schemes, malformed URLs, null/undefined/empty)

The `utils/` directory does not exist yet -- the file creation will implicitly create it.

Do NOT use regex for URL parsing. Do NOT use a blocklist approach. Do NOT add any npm dependencies.
  </action>
  <verify>
Run `bun run build` from `enterprise-work-assistant/` -- must compile with zero errors. Verify the file exists and exports `isSafeUrl` and `SAFE_PROTOCOLS` by checking the build output.
  </verify>
  <done>
`urlSanitizer.ts` exists with exported `SAFE_PROTOCOLS` Set and `isSafeUrl()` function using URL constructor + protocol allowlist. No external dependencies added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate URL sanitization into CardDetail.tsx</name>
  <files>enterprise-work-assistant/src/AssistantDashboard/components/CardDetail.tsx</files>
  <action>
Modify `CardDetail.tsx` to use the new `isSafeUrl()` utility for verified_sources URL rendering:

1. **Add import** at the top of the file (after existing imports):
```typescript
import { isSafeUrl } from "../utils/urlSanitizer";
```

2. **Replace the verified_sources link rendering** (lines 126-139). The current code:
```tsx
<Link
    href={/^https?:\/\//.test(source.url) ? source.url : "#"}
    target="_blank"
    rel="noopener noreferrer"
>
    {source.title}
</Link>
```

Replace with conditional rendering -- safe URLs get a `<Link>`, unsafe URLs get a `<Text>`:
```tsx
{isSafeUrl(source.url) ? (
    <Link
        href={source.url}
        target="_blank"
        rel="noopener noreferrer"
    >
        {source.title}
    </Link>
) : (
    <Text>{source.title}</Text>
)}
```

This produces NO `<a>` tag for unsafe URLs -- just plain text. The source title remains visible (not silently stripped) per the user decision in CONTEXT.md.

**What NOT to change:**
- Do not modify any other sections of CardDetail.tsx
- Do not remove the existing `Link` or `Text` imports (both are already imported and both will still be used)
- Keep `target="_blank"` and `rel="noopener noreferrer"` on the Link element (already correct)
  </action>
  <verify>
1. Run `bun run build` from `enterprise-work-assistant/` -- zero errors, zero warnings
2. Run `bun run lint` from `enterprise-work-assistant/` -- zero errors, zero warnings
3. Verify no `href="#"` remains in CardDetail.tsx (the old fallback pattern)
4. Verify no `/^https?:\/\//` regex remains in CardDetail.tsx (the old validation pattern)
5. Verify `isSafeUrl` import exists in CardDetail.tsx
  </verify>
  <done>
CardDetail.tsx imports `isSafeUrl` from the utility, renders safe URLs as `<Link>` and unsafe URLs as `<Text>`. No regex-based URL validation remains. No `href="#"` fallback remains. Build and lint pass clean.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `bun run build` passes with zero errors and zero warnings
2. `bun run lint` passes with zero errors and zero warnings
3. `urlSanitizer.ts` exists and exports `isSafeUrl` and `SAFE_PROTOCOLS`
4. `CardDetail.tsx` imports and uses `isSafeUrl()` for conditional Link/Text rendering
5. No `href="#"` fallback pattern exists anywhere in the codebase
6. No regex-based URL scheme checking exists in CardDetail.tsx
7. The `SAFE_PROTOCOLS` Set contains exactly `"https:"` and `"mailto:"` (no `http:`, no enterprise schemes)
</verification>

<success_criteria>
- External URLs with safe schemes (https:, mailto:) render as clickable Fluent UI Link elements
- External URLs with dangerous schemes (javascript:, data:, vbscript:, etc.) render as plain Fluent UI Text elements (visible but not clickable)
- Malformed, relative, or empty URLs render as plain text
- The URL validation is centralized in a single utility function (single source of truth for the allowlist)
- Zero new npm dependencies added
- Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/05-pcf-security-hardening/05-01-SUMMARY.md`
</output>
